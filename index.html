<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Ê≠£ÊúàÁâπË®ì„ÅÆÁî∫ - 2026</title>
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    :root {
      --snow-bg: #1a1a2e;
      --ground-color: #e8f4f8;
      --building-warm: #ffd93d;
      --text-color: #fff;
    }

    body {
      background: linear-gradient(180deg, #0f0f23 0%, #1a1a3e 50%, #2d2d5a 100%);
      min-height: 100vh;
      overflow: hidden;
      font-family: 'DotGothic16', sans-serif;
      image-rendering: pixelated;
      touch-action: manipulation;
      user-select: none;
      -webkit-user-select: none;
    }

    /* Èõ™„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
    .snowflakes {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 100;
      overflow: hidden;
    }

    .snowflake {
      position: absolute;
      color: #fff;
      font-size: 1em;
      text-shadow: 0 0 5px #fff;
      animation: fall linear infinite;
      opacity: 0.8;
    }

    @keyframes fall {
      0% { transform: translateY(-10vh) translateX(0); opacity: 1; }
      100% { transform: translateY(110vh) translateX(50px); opacity: 0.3; }
    }

    /* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„Éä */
    .game-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }

    /* „Çø„ÉÉ„Éó„Ç®„É™„Ç¢ÔºàÂ∑¶Âè≥ÁßªÂãïÁî®Ôºâ */
    .tap-area {
      position: fixed;
      top: 0;
      width: 50%;
      height: 100%;
      z-index: 50;
      cursor: pointer;
    }

    .tap-area.left { left: 0; }
    .tap-area.right { right: 0; }

    .tap-indicator {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      font-size: 40px;
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
    }

    .tap-area.left .tap-indicator { left: 20px; }
    .tap-area.right .tap-indicator { right: 20px; }

    .tap-area:active .tap-indicator { opacity: 0.5; }

    /* ËÉåÊôØ„ÅÆÂ±±„ÄÖ */
    .mountains {
      position: absolute;
      bottom: 180px;
      left: 0;
      width: 200%;
      height: 200px;
      z-index: 1;
    }

    .mountain {
      position: absolute;
      bottom: 0;
      width: 0;
      height: 0;
      border-style: solid;
    }

    .mountain-1 { left: 5%; border-width: 0 80px 120px 80px; border-color: transparent transparent #3d3d6b transparent; }
    .mountain-2 { left: 20%; border-width: 0 120px 180px 120px; border-color: transparent transparent #2d2d5a transparent; }
    .mountain-3 { left: 50%; border-width: 0 100px 150px 100px; border-color: transparent transparent #3d3d6b transparent; }
    .mountain-4 { left: 75%; border-width: 0 90px 130px 90px; border-color: transparent transparent #2d2d5a transparent; }

    /* Âú∞Èù¢ */
    .ground {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 180px;
      background: linear-gradient(180deg, #c8e6f0 0%, #e8f4f8 30%, #fff 100%);
      z-index: 2;
    }

    /* Áî∫„Ç®„É™„Ç¢ */
    .town {
      position: absolute;
      bottom: 60px;
      left: 0;
      width: 100%;
      height: 300px;
      z-index: 10;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 80px;
      padding: 0 20px;
    }

    /* Âª∫Áâ©ÂÖ±ÈÄö„Çπ„Çø„Ç§„É´ */
    .building {
      position: relative;
      cursor: pointer;
      transition: transform 0.2s ease;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3));
      z-index: 20;
    }

    .building:active {
      transform: translateY(-5px) scale(1.02);
    }

    .building-glow {
      position: absolute;
      bottom: -20px;
      left: 50%;
      transform: translateX(-50%);
      width: 120%;
      height: 40px;
      background: radial-gradient(ellipse at center, rgba(255, 217, 61, 0.4) 0%, transparent 70%);
      opacity: 0.5;
    }

    /* ÈÅéÂéªÂïèÈÅìÂ†¥ */
    .dojo {
      width: 140px;
    }

    .dojo-body {
      width: 140px;
      height: 110px;
      background: linear-gradient(180deg, #8b4513 0%, #654321 100%);
      border: 4px solid #3d2914;
      position: relative;
    }

    .dojo-roof {
      width: 160px;
      height: 55px;
      background: #1a1a2e;
      position: relative;
      left: -10px;
      clip-path: polygon(0% 100%, 50% 0%, 100% 100%);
    }

    .dojo-roof::after {
      content: '';
      position: absolute;
      top: 5px;
      left: 50%;
      transform: translateX(-50%);
      width: 150px;
      height: 50px;
      background: #2d2d4a;
      clip-path: polygon(0% 100%, 50% 0%, 100% 100%);
    }

    .dojo-window {
      position: absolute;
      width: 35px;
      height: 45px;
      background: var(--building-warm);
      border: 3px solid #3d2914;
      top: 20px;
      box-shadow: 0 0 20px rgba(255, 217, 61, 0.6);
    }

    .dojo-window.left { left: 15px; }
    .dojo-window.right { right: 15px; }

    .dojo-door {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 55px;
      background: #2d1810;
      border: 3px solid #1a0f0a;
    }

    .dojo-sign {
      position: absolute;
      top: -85px;
      left: 50%;
      transform: translateX(-50%);
      background: #8b4513;
      color: #fff;
      padding: 8px 12px;
      font-size: 12px;
      border: 3px solid #3d2914;
      white-space: nowrap;
    }

    /* Á•ûÁ§æÔºàÊôÇ‰∫ãÂïèÈ°åÔºâ */
    .shrine {
      width: 150px;
    }

    .torii {
      width: 120px;
      height: 80px;
      position: relative;
      margin: 0 auto 10px;
    }

    .torii-top {
      position: absolute;
      top: 0;
      left: -15px;
      width: 150px;
      height: 18px;
      background: #c41e3a;
      border-radius: 3px;
    }

    .torii-beam {
      position: absolute;
      top: 25px;
      left: 0;
      width: 120px;
      height: 12px;
      background: #c41e3a;
    }

    .torii-pillar {
      position: absolute;
      top: 18px;
      width: 14px;
      height: 62px;
      background: #c41e3a;
    }

    .torii-pillar.left { left: 12px; }
    .torii-pillar.right { right: 12px; }

    .shrine-body {
      width: 150px;
      height: 90px;
      background: linear-gradient(180deg, #f5f5f5 0%, #e0e0e0 100%);
      border: 4px solid #bbb;
      position: relative;
    }

    .shrine-roof {
      width: 170px;
      height: 50px;
      background: #2d4a2d;
      position: relative;
      left: -10px;
      clip-path: polygon(0% 100%, 10% 0%, 90% 0%, 100% 100%);
    }

    .shrine-door {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 45px;
      height: 55px;
      background: #8b4513;
      border: 3px solid #654321;
    }

    .shrine-lantern {
      position: absolute;
      bottom: 65px;
      width: 22px;
      height: 32px;
      background: #ff6b6b;
      border-radius: 5px;
      box-shadow: 0 0 20px rgba(255, 107, 107, 0.8);
      animation: lanternGlow 2s ease-in-out infinite alternate;
    }

    @keyframes lanternGlow {
      0% { box-shadow: 0 0 15px rgba(255, 107, 107, 0.6); }
      100% { box-shadow: 0 0 25px rgba(255, 107, 107, 1); }
    }

    .shrine-lantern.left { left: 15px; }
    .shrine-lantern.right { right: 15px; }

    .shrine-sign {
      position: absolute;
      top: -85px;
      left: 50%;
      transform: translateX(-50%);
      background: #f5f5dc;
      color: #333;
      padding: 8px 12px;
      font-size: 12px;
      border: 3px solid #8b4513;
      white-space: nowrap;
    }

    /* Êú®„ÄÖ */
    .tree {
      position: absolute;
      z-index: 5;
    }

    .tree-trunk {
      width: 20px;
      height: 40px;
      background: #4a3728;
      margin: 0 auto;
    }

    .tree-snow {
      width: 60px;
      height: 80px;
      background: radial-gradient(ellipse at center, #e8f4f8 0%, #c8dae8 100%);
      border-radius: 50%;
      position: relative;
      left: -20px;
    }

    .tree-snow::before {
      content: '';
      position: absolute;
      top: -30px;
      left: 10px;
      width: 40px;
      height: 50px;
      background: radial-gradient(ellipse at center, #e8f4f8 0%, #c8dae8 100%);
      border-radius: 50%;
    }

    .tree.t1 { left: 3%; bottom: 200px; transform: scale(0.8); }
    .tree.t2 { right: 3%; bottom: 210px; transform: scale(0.9); }

    /* „Éó„É¨„Ç§„É§„ÉºÔºàÈ¶¨Ôºâ */
    .player {
      position: absolute;
      bottom: 100px;
      left: 88%;
      transform: translateX(-50%);
      z-index: 60;
      transition: left 0.2s ease-out;
    }

    .horse {
      font-size: 56px;
      filter: drop-shadow(0 5px 10px rgba(0,0,0,0.3));
      animation: horseIdle 0.5s ease-in-out infinite alternate;
    }

    .horse.flip {
      transform: scaleX(-1);
    }

    .horse.walking {
      animation: horseWalk 0.15s steps(2) infinite;
    }

    @keyframes horseIdle {
      0% { transform: translateY(0); }
      100% { transform: translateY(-3px); }
    }

    @keyframes horseWalk {
      0% { transform: translateY(0) rotate(-2deg); }
      50% { transform: translateY(-5px) rotate(2deg); }
      100% { transform: translateY(0) rotate(-2deg); }
    }

    /* UIË¶ÅÁ¥† */
    .ui-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 200;
      padding: 15px;
      pointer-events: none;
    }

    .title-box {
      background: rgba(0, 0, 0, 0.85);
      border: 4px solid #ffd93d;
      padding: 12px 20px;
      display: inline-block;
      position: relative;
    }

    .title-box h1 {
      color: #ffd93d;
      font-size: 22px;
      text-shadow: 2px 2px 0 #000;
      margin-bottom: 3px;
    }

    .title-box .subtitle {
      color: #fff;
      font-size: 11px;
    }

    .title-box .year-badge {
      position: absolute;
      top: -12px;
      right: -12px;
      background: #c41e3a;
      color: #fff;
      padding: 4px 8px;
      font-size: 11px;
      border: 2px solid #ffd93d;
    }

    .controls-hint {
      background: rgba(0, 0, 0, 0.7);
      border: 2px solid #888;
      padding: 8px 12px;
      margin-top: 8px;
      display: inline-block;
    }

    .controls-hint p {
      color: #ccc;
      font-size: 11px;
      margin: 2px 0;
    }

    /* ÊòüÁ©∫ */
    .stars {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 60%;
      z-index: 0;
    }

    .star {
      position: absolute;
      width: 3px;
      height: 3px;
      background: #fff;
      border-radius: 50%;
      animation: twinkle 2s ease-in-out infinite;
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }

    /* Ë°óÁÅØ */
    .lamp-post {
      position: absolute;
      z-index: 8;
    }

    .lamp-pole {
      width: 8px;
      height: 80px;
      background: #333;
      margin: 0 auto;
    }

    .lamp-light {
      width: 25px;
      height: 20px;
      background: #ffd93d;
      border-radius: 5px 5px 10px 10px;
      position: relative;
      left: -8px;
      box-shadow: 0 0 30px rgba(255, 217, 61, 0.8), 0 0 60px rgba(255, 217, 61, 0.4);
    }

    .lamp-post.l1 { left: 15%; bottom: 180px; }
    .lamp-post.l2 { right: 15%; bottom: 180px; }

    /* ÈñÄÊùæ */
    .kadomatsu {
      position: absolute;
      font-size: 45px;
      z-index: 15;
    }

    .kadomatsu.k1 { left: 1%; bottom: 180px; }
    .kadomatsu.k2 { right: 1%; bottom: 180px; }

    /* ========== NPC„Ç≠„É£„É©„ÇØ„Çø„Éº ========== */
    .npc {
      position: absolute;
      z-index: 45;
      cursor: pointer;
    }

    /* So much happy */
    .npc-kitataya {
      bottom: 95px;
      right: 22%;
    }

    .kitataya-head {
      width: 38px;
      height: 38px;
      background: #ffd5b5;
      border-radius: 50%;
      margin: 0 auto;
      position: relative;
      border: 2px solid #d4a574;
    }

    .kitataya-hair {
      position: absolute;
      top: -5px;
      left: -3px;
      width: 44px;
      height: 28px;
      background: #2d2d2d;
      border-radius: 50% 50% 0 0;
    }

    .kitataya-eyes {
      position: absolute;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
    }

    .kitataya-eye {
      width: 5px;
      height: 5px;
      background: #000;
      border-radius: 50%;
    }

    .kitataya-smile {
      position: absolute;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      width: 14px;
      height: 7px;
      border: 2px solid #c41e3a;
      border-top: none;
      border-radius: 0 0 10px 10px;
    }

    .kitataya-body {
      width: 32px;
      height: 38px;
      background: linear-gradient(180deg, #4a90d9 0%, #3a7bc8 100%);
      margin: 0 auto;
      border-radius: 5px 5px 0 0;
      position: relative;
    }

    .kitataya-tie {
      position: absolute;
      top: 2px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 10px solid #c41e3a;
    }

    .npc-name {
      position: absolute;
      bottom: -28px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.85);
      color: #7fff7f;
      padding: 4px 10px;
      font-size: 10px;
      white-space: nowrap;
      border: 2px solid #7fff7f;
    }

    /* „Ç≠„Çø„É§„Éû („É°„Çø„Éà„É≥È¢®) */
    .npc-kitayama {
      bottom: 95px;
      left: -100px;
      transition: left 1s ease-out;
    }

    .npc-kitayama.appear {
      left: 8%;
    }

    .kitayama-head {
      width: 34px;
      height: 40px;
      background: linear-gradient(180deg, #ffd5b5 0%, #f0c5a5 100%);
      margin: 0 auto;
      position: relative;
      border: 2px solid #d4a574;
      border-radius: 5px 5px 10px 10px;
    }

    .kitayama-hair {
      position: absolute;
      top: -10px;
      left: -6px;
      width: 46px;
      height: 32px;
      background: linear-gradient(180deg, #1a1a1a 0%, #333 100%);
      clip-path: polygon(10% 100%, 0% 40%, 20% 0%, 80% 0%, 100% 40%, 90% 100%, 70% 80%, 50% 100%, 30% 80%);
    }

    .kitayama-eyes {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 12px;
    }

    .kitayama-eye {
      width: 6px;
      height: 3px;
      background: #000;
      border-radius: 0 0 3px 3px;
    }

    .kitayama-sparkle {
      position: absolute;
      top: 8px;
      right: -2px;
      font-size: 12px;
      animation: sparkle 1s ease-in-out infinite;
    }

    @keyframes sparkle {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.3); }
    }

    .kitayama-smirk {
      position: absolute;
      bottom: 8px;
      left: 55%;
      transform: translateX(-50%);
      width: 12px;
      height: 5px;
      border: 2px solid #333;
      border-top: none;
      border-left: none;
      border-radius: 0 0 6px 0;
    }

    .kitayama-body {
      width: 30px;
      height: 48px;
      background: linear-gradient(180deg, #1a1a1a 0%, #333 100%);
      margin: 0 auto;
      position: relative;
      clip-path: polygon(0% 0%, 100% 0%, 90% 100%, 10% 100%);
    }

    .kitayama-collar {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 22px;
      height: 10px;
      background: #fff;
      clip-path: polygon(0% 0%, 100% 0%, 80% 100%, 20% 100%);
    }

    .kitayama-legs {
      display: flex;
      justify-content: center;
      gap: 5px;
    }

    .kitayama-leg {
      width: 9px;
      height: 16px;
      background: #1a1a1a;
    }

    /* „Ç§„Éô„É≥„Éà„Ç™„Éº„Éê„Éº„É¨„Ç§ */
    .event-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0);
      z-index: 280;
      pointer-events: none;
      transition: background 0.3s;
    }

    .event-overlay.active {
      background: rgba(0, 0, 0, 0.4);
      pointer-events: auto;
    }

    /* „Ç§„Éô„É≥„Éà„ÉÄ„Ç§„Ç¢„É≠„Ç∞ */
    .event-dialog {
      position: fixed;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      width: 94%;
      max-width: 600px;
      background: #000;
      border: 4px solid #fff;
      z-index: 350;
      display: none;
    }

    .event-dialog.active {
      display: block;
      animation: dialogAppear 0.2s ease-out;
    }

    @keyframes dialogAppear {
      0% { transform: translateX(-50%) scale(0.9); opacity: 0; }
      100% { transform: translateX(-50%) scale(1); opacity: 1; }
    }

    .event-dialog-header {
      background: #222;
      padding: 10px 15px;
      border-bottom: 2px solid #444;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .speaker-icon { font-size: 28px; }
    .speaker-name { color: #ffd93d; font-size: 15px; }

    .event-dialog-content {
      padding: 18px;
      min-height: 80px;
    }

    .event-dialog-content p {
      color: #fff;
      font-size: 15px;
      line-height: 1.8;
    }

    .event-dialog-choices {
      padding: 12px 18px;
      display: flex;
      gap: 12px;
      justify-content: center;
      border-top: 2px solid #333;
      flex-wrap: wrap;
    }

    .choice-btn {
      background: #222;
      border: 3px solid #ffd93d;
      color: #ffd93d;
      padding: 14px 28px;
      font-family: 'DotGothic16', sans-serif;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.15s ease;
      min-width: 120px;
    }

    .choice-btn:active {
      background: #ffd93d;
      color: #000;
      transform: scale(0.95);
    }

    .choice-btn.changing {
      animation: buttonShake 0.4s ease;
    }

    @keyframes buttonShake {
      0%, 100% { transform: translateX(0); }
      20% { transform: translateX(-8px) rotate(-2deg); }
      40% { transform: translateX(8px) rotate(2deg); }
      60% { transform: translateX(-6px) rotate(-1deg); }
      80% { transform: translateX(6px) rotate(1deg); }
    }

    .choice-btn.forced {
      background: #c41e3a;
      border-color: #ff6b6b;
      color: #fff;
    }

    /* ÊÑüÂòÜÁ¨¶„Ç®„Éï„Çß„ÇØ„Éà */
    .exclamation {
      position: fixed;
      font-size: 35px;
      color: #ff0;
      text-shadow: 0 0 10px #ff0, 2px 2px 0 #000;
      animation: exclamationPop 0.5s ease-out;
      z-index: 400;
      pointer-events: none;
    }

    @keyframes exclamationPop {
      0% { transform: scale(0) translateY(20px); opacity: 0; }
      50% { transform: scale(1.4) translateY(-10px); opacity: 1; }
      100% { transform: scale(1) translateY(0); opacity: 1; }
    }

    /* „Ç®„É≥„Éá„Ç£„É≥„Ç∞ */
    .ending-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0);
      z-index: 500;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      opacity: 0;
      transition: all 1s ease;
    }

    .ending-overlay.active {
      background: rgba(0, 0, 0, 0.9);
      opacity: 1;
      pointer-events: auto;
    }

    .ending-horse {
      font-size: 100px;
      animation: endingSpin 2s linear infinite;
      margin-bottom: 30px;
    }

    @keyframes endingSpin {
      0% { transform: rotate(0deg) scale(1); }
      25% { transform: rotate(90deg) scale(1.1); }
      50% { transform: rotate(180deg) scale(1.2); }
      75% { transform: rotate(270deg) scale(1.1); }
      100% { transform: rotate(360deg) scale(1); }
    }

    .ending-message {
      color: #ffd93d;
      font-size: 32px;
      text-align: center;
      text-shadow: 3px 3px 0 #000;
      animation: endingFade 1s ease-out 0.5s both;
      padding: 0 20px;
    }

    .ending-submessage {
      color: #fff;
      font-size: 18px;
      margin-top: 25px;
      text-align: center;
      line-height: 1.8;
      animation: endingFade 1s ease-out 1.5s both;
    }

    @keyframes endingFade {
      0% { opacity: 0; transform: translateY(20px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    .ending-restart {
      margin-top: 50px;
      background: #ffd93d;
      color: #000;
      border: none;
      padding: 18px 50px;
      font-family: 'DotGothic16', sans-serif;
      font-size: 18px;
      cursor: pointer;
      animation: endingFade 1s ease-out 2.5s both;
      border-radius: 5px;
    }

    .ending-restart:active {
      transform: scale(0.95);
      background: #fff;
    }

    /* BGM„Ç≥„É≥„Éà„É≠„Éº„É´ */
    .bgm-control {
      position: fixed;
      top: 15px;
      right: 15px;
      z-index: 250;
    }

    .bgm-btn {
      background: rgba(0, 0, 0, 0.7);
      border: 2px solid #ffd93d;
      color: #ffd93d;
      padding: 8px 15px;
      font-family: 'DotGothic16', sans-serif;
      font-size: 12px;
      cursor: pointer;
      border-radius: 5px;
      transition: all 0.2s;
    }

    .bgm-btn:active {
      background: #ffd93d;
      color: #000;
    }

    .bgm-btn.playing {
      background: rgba(255, 217, 61, 0.3);
    }

    /* BGMÈñãÂßã„Éó„É≠„É≥„Éó„Éà */
    .bgm-prompt {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 600;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 1;
      transition: opacity 0.5s;
    }

    .bgm-prompt.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .bgm-prompt-content {
      text-align: center;
    }

    .bgm-prompt-title {
      color: #ffd93d;
      font-size: 28px;
      margin-bottom: 20px;
      text-shadow: 2px 2px 0 #000;
    }

    .bgm-prompt-horse {
      font-size: 80px;
      margin-bottom: 30px;
      animation: horseIdle 0.5s ease-in-out infinite alternate;
    }

    .bgm-prompt-text {
      color: #fff;
      font-size: 14px;
      margin-bottom: 30px;
    }

    .bgm-prompt-btn {
      background: #ffd93d;
      border: none;
      color: #000;
      padding: 18px 50px;
      font-family: 'DotGothic16', sans-serif;
      font-size: 18px;
      cursor: pointer;
      border-radius: 5px;
      margin: 10px;
      transition: transform 0.1s;
    }

    .bgm-prompt-btn:active {
      transform: scale(0.95);
    }

    .bgm-prompt-btn.secondary {
      background: #333;
      color: #fff;
      border: 2px solid #666;
    }

    /* YouTubeÂüã„ÇÅËæº„Åø„É¢„Éº„ÉÄ„É´ */
    .video-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 700;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .video-modal.active {
      display: flex;
    }

    .video-modal-header {
      color: #ffd93d;
      font-size: 18px;
      margin-bottom: 15px;
      text-align: center;
    }

    .video-container {
      width: 100%;
      max-width: 800px;
      aspect-ratio: 16 / 9;
      background: #000;
      border: 4px solid #ffd93d;
      border-radius: 8px;
      overflow: hidden;
    }

    .video-container iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* Â§ß„Åç„ÅÑÂãïÁîª„É¢„Éº„ÉÄ„É´Ôºà„Ç≠„Çø„É§„ÉûËã±Ë™ûËß£Ë™¨Áî®Ôºâ */
    .video-modal.large .video-container {
      max-width: 95vw;
      max-height: 80vh;
      width: 95vw;
      height: 80vh;
      aspect-ratio: auto;
    }

    .video-modal.large .video-modal-header {
      font-size: 22px;
      margin-bottom: 10px;
    }

    .video-close-btn {
      margin-top: 20px;
      background: #ffd93d;
      border: none;
      color: #000;
      padding: 15px 40px;
      font-family: 'DotGothic16', sans-serif;
      font-size: 16px;
      cursor: pointer;
      border-radius: 5px;
    }

    .video-close-btn:active {
      transform: scale(0.95);
      background: #fff;
    }

    .video-modal.large .video-close-btn {
      margin-top: 15px;
      padding: 18px 50px;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <!-- BGM -->
  <audio id="bgm" loop>
    <source src="bgm2.mp3" type="audio/mpeg">
  </audio>

  <!-- BGM„Ç≥„É≥„Éà„É≠„Éº„É´ -->
  <div class="bgm-control" id="bgmControl">
    <button class="bgm-btn" id="bgmBtn" onclick="toggleBGM()">üîá BGM</button>
  </div>

  <!-- ÊòüÁ©∫ -->
  <div class="stars" id="stars"></div>

  <!-- Èõ™ -->
  <div class="snowflakes" id="snowflakes"></div>

  <!-- „Çø„ÉÉ„Éó„Ç®„É™„Ç¢ -->
  <div class="tap-area left" id="tapLeft">
    <div class="tap-indicator">‚óÄ</div>
  </div>
  <div class="tap-area right" id="tapRight">
    <div class="tap-indicator">‚ñ∂</div>
  </div>

  <!-- „Ç§„Éô„É≥„Éà„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
  <div class="event-overlay" id="eventOverlay"></div>

  <div class="game-container">
    <!-- Â±±„ÄÖ -->
    <div class="mountains">
      <div class="mountain mountain-1"></div>
      <div class="mountain mountain-2"></div>
      <div class="mountain mountain-3"></div>
      <div class="mountain mountain-4"></div>
    </div>

    <!-- Êú®„ÄÖ -->
    <div class="tree t1">
      <div class="tree-snow"></div>
      <div class="tree-trunk"></div>
    </div>
    <div class="tree t2">
      <div class="tree-snow"></div>
      <div class="tree-trunk"></div>
    </div>

    <!-- Ë°óÁÅØ -->
    <div class="lamp-post l1">
      <div class="lamp-light"></div>
      <div class="lamp-pole"></div>
    </div>
    <div class="lamp-post l2">
      <div class="lamp-light"></div>
      <div class="lamp-pole"></div>
    </div>

    <!-- ÈñÄÊùæ -->
    <div class="kadomatsu k1">üéç</div>
    <div class="kadomatsu k2">üéç</div>

    <!-- Âú∞Èù¢ -->
    <div class="ground"></div>

    <!-- NPC: So much happy -->
    <div class="npc npc-kitataya" id="npcKitataya">
      <div class="kitataya-head">
        <div class="kitataya-hair"></div>
        <div class="kitataya-eyes">
          <div class="kitataya-eye"></div>
          <div class="kitataya-eye"></div>
        </div>
        <div class="kitataya-smile"></div>
      </div>
      <div class="kitataya-body">
        <div class="kitataya-tie"></div>
      </div>
      <div class="npc-name">So much happy</div>
    </div>

    <!-- NPC: „Ç≠„Çø„É§„Éû -->
    <div class="npc npc-kitayama" id="npcKitayama">
      <div class="kitayama-head">
        <div class="kitayama-hair"></div>
        <div class="kitayama-eyes">
          <div class="kitayama-eye"></div>
          <div class="kitayama-eye"></div>
        </div>
        <div class="kitayama-sparkle">‚ú®</div>
        <div class="kitayama-smirk"></div>
      </div>
      <div class="kitayama-body">
        <div class="kitayama-collar"></div>
      </div>
      <div class="kitayama-legs">
        <div class="kitayama-leg"></div>
        <div class="kitayama-leg"></div>
      </div>
      <div class="npc-name">„Ç≠„Çø„É§„Éû</div>
    </div>

    <!-- Áî∫„ÅÆÂª∫Áâ© -->
    <div class="town">
      <!-- ÈÅéÂéªÂïèÈÅìÂ†¥ -->
      <div class="building dojo" id="buildingDojo">
        <div class="building-glow"></div>
        <div class="dojo-sign">ü•ã ÈÅéÂéªÂïèÈÅìÂ†¥</div>
        <div class="dojo-roof"></div>
        <div class="dojo-body">
          <div class="dojo-window left"></div>
          <div class="dojo-window right"></div>
          <div class="dojo-door"></div>
        </div>
      </div>

      <!-- Á•ûÁ§æÔºàÊôÇ‰∫ãÂïèÈ°åÔºâ -->
      <div class="building shrine" id="buildingShrine">
        <div class="building-glow"></div>
        <div class="shrine-sign">‚õ©Ô∏è ÊôÇ‰∫ãÂïèÈ°åÁ•ûÁ§æ</div>
        <div class="torii">
          <div class="torii-top"></div>
          <div class="torii-beam"></div>
          <div class="torii-pillar left"></div>
          <div class="torii-pillar right"></div>
        </div>
        <div class="shrine-roof"></div>
        <div class="shrine-body">
          <div class="shrine-lantern left"></div>
          <div class="shrine-lantern right"></div>
          <div class="shrine-door"></div>
        </div>
      </div>
    </div>

    <!-- „Éó„É¨„Ç§„É§„Éº -->
    <div class="player" id="player">
      <div class="horse" id="horse">üê¥</div>
    </div>
  </div>

  <!-- UI -->
  <div class="ui-overlay">
    <div class="title-box">
      <div class="year-badge">üê¥ 2026</div>
      <h1>Ê≠£ÊúàÁâπË®ì„ÅÆÁî∫</h1>
      <div class="subtitle">„Äú ÂêàÊ†º„ÇíÁõÆÊåá„ÅôÂÜíÈô∫„Å∏ „Äú</div>
    </div>
    <div class="controls-hint">
      <p>üì± ÁîªÈù¢„ÅÆÂ∑¶Âè≥„Çí„Çø„ÉÉ„Éó„ÅßÁßªÂãï</p>
      <p>üè† Âª∫Áâ©„ÇÑ„Ç≠„É£„É©„Çí„Çø„ÉÉ„Éó„Åß‰ºöË©±</p>
    </div>
  </div>

  <!-- „Ç§„Éô„É≥„Éà„ÉÄ„Ç§„Ç¢„É≠„Ç∞ -->
  <div class="event-dialog" id="eventDialog">
    <div class="event-dialog-header">
      <span class="speaker-icon" id="speakerIcon">üòä</span>
      <span class="speaker-name" id="speakerName">???</span>
    </div>
    <div class="event-dialog-content">
      <p id="eventText"></p>
    </div>
    <div class="event-dialog-choices" id="eventChoices"></div>
  </div>

  <!-- YouTubeÂüã„ÇÅËæº„Åø„É¢„Éº„ÉÄ„É´ -->
  <div class="video-modal" id="videoModal">
    <div class="video-modal-header" id="videoModalTitle">üì∫ ÂãïÁîª„ÇíË¶ã„Çã</div>
    <div class="video-container">
      <iframe id="videoIframe" src="" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe>
    </div>
    <button class="video-close-btn" onclick="closeVideo()">‚úï Èñâ„Åò„Å¶ÈÄ≤„ÇÄ</button>
  </div>

  <!-- BGMÈñãÂßã„Éó„É≠„É≥„Éó„Éà -->
  <div class="bgm-prompt" id="bgmPrompt">
    <div class="bgm-prompt-content">
      <div class="bgm-prompt-title">üéç Ê≠£ÊúàÁâπË®ì„ÅÆÁî∫ üéç</div>
      <div class="bgm-prompt-horse">üê¥</div>
      <div class="bgm-prompt-text">BGM„ÇíÂÜçÁîü„Åó„Åæ„Åô„ÅãÔºü</div>
      <button class="bgm-prompt-btn" onclick="startWithBGM()">üîä BGM„ÅÇ„Çä</button>
      <button class="bgm-prompt-btn secondary" onclick="startWithoutBGM()">üîá BGM„Å™„Åó</button>
    </div>
  </div>

  <!-- „Ç®„É≥„Éá„Ç£„É≥„Ç∞ -->
  <div class="ending-overlay" id="endingOverlay">
    <div class="ending-horse">üê¥</div>
    <div class="ending-message">üéç 2026Âπ¥„ÇÇÈ†ëÂºµ„Çç„ÅÜÔºÅ üéç</div>
    <div class="ending-submessage">
      Ê≠£ÊúàÁâπË®ì„ÄÅ„ÅäÁñ≤„Çå„Åï„Åæ„Åß„Åó„ÅüÔºÅ<br>
      ÂêàÊ†ºÁõÆÊåá„Åó„Å¶ÈßÜ„ÅëÊäú„Åë„Çà„ÅÜÔºÅ<br><br>
      üå∏ Êò•„ÅØ„ÇÇ„ÅÜ„Åô„Åê„Åù„Åì„Å†ÔºÅ üå∏
    </div>
    <button class="ending-restart" onclick="location.reload()">üîÑ „ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊúÄÂàù„Åã„Çâ</button>
  </div>

  <script>
    // ========== „Ç≤„Éº„É†Áä∂ÊÖãÁÆ°ÁêÜ ==========
    // „Ç§„Éô„É≥„Éà„Éà„É™„Ç¨„Éº‰ΩçÁΩÆÔºàÂè≥„Åã„ÇâÂ∑¶„Å∏Ôºâ
    // 88% „Çπ„Çø„Éº„Éà
    // 72% So much happy
    // 55% Á•ûÁ§æ
    // 38% ÈÅìÂ†¥
    // 18% „Ç≠„Çø„É§„ÉûÁôªÂ†¥
    
    const gameState = {
      playerX: 88,
      canMove: true,
      // „Ç§„Éô„É≥„Éà„Éï„É©„Ç∞
      kitatayaTalked: false,      // So much happy„Å®Ë©±„Åó„Åü
      shrineTalked: false,        // Á•ûÁ§æ„ÅßË©±„Åó„Åü
      dojoTalked: false,          // ÈÅìÂ†¥„ÅßË©±„Åó„Åü
      kitayamaAppeared: false,    // „Ç≠„Çø„É§„ÉûÁôªÂ†¥Ê∏à„Åø
      kitayamaEventDone: false,   // „Ç≠„Çø„É§„Éû„Ç§„Éô„É≥„ÉàÂÆå‰∫Ü
      englishTestDone: false      // Ëã±Ë™û„ÉÜ„Çπ„ÉàÁµÇ„Çè„Å£„ÅüË®≠ÂÆö
    };

    // „Éà„É™„Ç¨„Éº‰ΩçÁΩÆ
    const TRIGGER = {
      KITATAYA: 72,
      SHRINE: 55,
      DOJO: 38,
      KITAYAMA: 18
    };

    // ========== DOMË¶ÅÁ¥† ==========
    const player = document.getElementById('player');
    const horse = document.getElementById('horse');
    const eventOverlay = document.getElementById('eventOverlay');
    const eventDialog = document.getElementById('eventDialog');
    const npcKitayama = document.getElementById('npcKitayama');
    const endingOverlay = document.getElementById('endingOverlay');

    let walkTimeout = null;
    let moveInterval = null;

    // ========== „Éó„É¨„Ç§„É§„ÉºÁßªÂãï ==========
    function movePlayer(direction) {
      if (!gameState.canMove) return;

      const step = 2;
      const oldX = gameState.playerX;

      if (direction === 'left') {
        const newX = gameState.playerX - step;
        
        // ÂêÑ„Éà„É™„Ç¨„Éº„Éù„Ç§„É≥„Éà„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØÔºàÂ∑¶„Å´ÈÄ≤„ÇÄÊôÇÔºâ
        // So much happy
        if (!gameState.kitatayaTalked && oldX > TRIGGER.KITATAYA && newX <= TRIGGER.KITATAYA) {
          triggerKitatayaEvent();
          return;
        }
        // Á•ûÁ§æ
        if (!gameState.shrineTalked && oldX > TRIGGER.SHRINE && newX <= TRIGGER.SHRINE) {
          triggerShrineEvent();
          return;
        }
        // ÈÅìÂ†¥
        if (!gameState.dojoTalked && oldX > TRIGGER.DOJO && newX <= TRIGGER.DOJO) {
          triggerDojoEvent();
          return;
        }
        // „Ç≠„Çø„É§„Éû
        if (!gameState.kitayamaAppeared && oldX > TRIGGER.KITAYAMA && newX <= TRIGGER.KITAYAMA) {
          triggerKitayamaAppearance();
          return;
        }

        if (newX >= 8) {
          gameState.playerX = newX;
          horse.classList.add('flip');
        }
      } else if (direction === 'right') {
        if (gameState.playerX < 92) {
          gameState.playerX += step;
          horse.classList.remove('flip');
        }
      }

      player.style.left = gameState.playerX + '%';
      horse.classList.add('walking');
      clearTimeout(walkTimeout);
      walkTimeout = setTimeout(() => horse.classList.remove('walking'), 200);
    }

    // ========== „Çø„ÉÉ„ÉóÊìç‰Ωú ==========
    function startMove(direction) {
      movePlayer(direction);
      moveInterval = setInterval(() => movePlayer(direction), 80);
    }

    function stopMove() {
      clearInterval(moveInterval);
      horse.classList.remove('walking');
    }

    document.getElementById('tapLeft').addEventListener('touchstart', (e) => {
      e.preventDefault();
      startMove('left');
    });
    document.getElementById('tapLeft').addEventListener('touchend', stopMove);
    document.getElementById('tapLeft').addEventListener('touchcancel', stopMove);

    document.getElementById('tapRight').addEventListener('touchstart', (e) => {
      e.preventDefault();
      startMove('right');
    });
    document.getElementById('tapRight').addEventListener('touchend', stopMove);
    document.getElementById('tapRight').addEventListener('touchcancel', stopMove);

    // „Éû„Ç¶„ÇπÊìç‰ΩúÔºàPCÁî®Ôºâ
    document.getElementById('tapLeft').addEventListener('mousedown', () => startMove('left'));
    document.getElementById('tapLeft').addEventListener('mouseup', stopMove);
    document.getElementById('tapLeft').addEventListener('mouseleave', stopMove);
    document.getElementById('tapRight').addEventListener('mousedown', () => startMove('right'));
    document.getElementById('tapRight').addEventListener('mouseup', stopMove);
    document.getElementById('tapRight').addEventListener('mouseleave', stopMove);

    // Âª∫Áâ©„Çø„ÉÉ„Éó
    document.getElementById('buildingDojo').addEventListener('click', (e) => {
      e.stopPropagation();
      if (gameState.canMove && !gameState.dojoTalked) triggerDojoEvent();
    });

    document.getElementById('buildingShrine').addEventListener('click', (e) => {
      e.stopPropagation();
      if (gameState.canMove && !gameState.shrineTalked) triggerShrineEvent();
    });

    document.getElementById('npcKitataya').addEventListener('click', (e) => {
      e.stopPropagation();
      if (gameState.canMove && !gameState.kitatayaTalked) triggerKitatayaEvent();
    });

    // ========== So much happy „Ç§„Éô„É≥„Éà ==========
    function triggerKitatayaEvent() {
      gameState.canMove = false;
      stopMove();
      showExclamation(document.getElementById('npcKitataya'));

      setTimeout(() => {
        showEventDialog({
          speaker: 'So much happy',
          icon: 'üòä',
          text: '„Å°„Çá„Å£„Å®ÂæÖ„Å£„Å¶ÔºÅ\n\n„ÅÇ„Åë„Åæ„Åó„Å¶„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅÔºÅ\nÊñ∞Âπ¥„ÅÆ„ÅîÊå®Êã∂„ÄÅËÅû„ÅÑ„Å¶„ÅÑ„Åã„Å™„ÅÑÔºü',
          choices: [
            { text: 'ËÅû„Åè', action: () => kitatayaGreeting() },
            { text: 'ËÅû„Åã„Å™„ÅÑ', action: () => kitatayaForceChoice(), canChange: true }
          ]
        });
      }, 500);
    }

    function kitatayaForceChoice() {
      const noBtn = document.querySelector('.choice-btn.no-btn');
      if (noBtn) {
        noBtn.classList.add('changing');
        setTimeout(() => {
          noBtn.textContent = 'ËÅû„Åè';
          noBtn.classList.remove('changing');
          noBtn.classList.add('forced');
          noBtn.onclick = () => kitatayaGreeting();
        }, 400);
      }
    }

    function kitatayaGreeting() {
      showEventDialog({
        speaker: 'So much happy',
        icon: 'üéâ',
        text: '„ÇÑ„Å£„Åü„ÉºÔºÅËÅû„ÅÑ„Å¶„Åè„Çå„Çã„Çì„Å†ÔºÅ\n\nüéç „ÅÇ„Åë„Åæ„Åó„Å¶„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ üéç\n\n‰ªäÂπ¥„ÇÇÁöÜ„Åï„Çì„Å´„Å®„Å£„Å¶\nSo much happy „Å™‰∏ÄÂπ¥„Å´„Å™„Çä„Åæ„Åô„Çà„ÅÜ„Å´ÔºÅ\n\nÂèóÈ®ìÁîü„ÅÆÁöÜ„Åï„Çì„ÄÅÊúÄÂæå„Åæ„ÅßË´¶„ÇÅ„Åö„Å´\nÈ†ëÂºµ„Å£„Å¶„ÅÑ„Åç„Åæ„Åó„Çá„ÅÜÔºÅÔºÅ\n\nüì∫ Êñ∞Âπ¥„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏ÂãïÁîª„ÇÇË¶ã„Å¶„ÅÑ„Å£„Å¶„Å≠ÔºÅ',
        choices: [{ text: 'ÂãïÁîª„ÇíË¶ã„ÇãÔºÅ', action: () => {
          gameState.kitatayaTalked = true;
          gameState.canMove = true;
          closeEventDialog();
          // Âüã„ÇÅËæº„ÅøÂãïÁîª„ÇíË°®Á§∫
          openVideo(VIDEO_IDS.soMuchHappy, 'üéâ So much happy Êñ∞Âπ¥„É°„ÉÉ„Çª„Éº„Ç∏', null);
        }}]
      });
    }

    // ========== Á•ûÁ§æÔºàÊôÇ‰∫ãÂïèÈ°åÔºâ„Ç§„Éô„É≥„Éà ==========
    function triggerShrineEvent() {
      gameState.canMove = false;
      stopMove();
      showExclamation(document.getElementById('buildingShrine'));

      setTimeout(() => {
        showEventDialog({
          speaker: 'Á•û‰∏ª',
          icon: '‚õ©Ô∏è',
          text: '„Åä„Åä„ÄÅÂèÇÊãùËÄÖ„Çà„ÄÇ\n\n„Åì„Åì„ÅØÊôÇ‰∫ãÂïèÈ°åÁ•ûÁ§æ„Åò„ÇÉ„ÄÇ\n\n2025Âπ¥„ÅÆÊôÇ‰∫ãÂïèÈ°å„ÇØ„Ç§„Ç∫„Å´\n„ÉÅ„É£„É¨„É≥„Ç∏„Åó„Å¶„ÅÑ„Åã„Å¨„ÅãÔºü\n\n‚ùì ÂÖ®40Âïè\n‚è±Ô∏è Á¥Ñ15ÂàÜ\n\nÊôÇ‰∫ã„ÇíÁü•„ÇãËÄÖ„Å´„ÄÅÂêàÊ†º„ÅÆÁ•ûÊßò„ÅØÂæÆÁ¨ë„ÇÄ„ÅûÔºÅ\n\nüö® Êú≠ÂπåÊó•Â§ß‰∏≠ÂèóÈ®ìËÄÖ„ÅØÂøÖÈ†à„Åò„ÇÉÔºÅ',
          choices: [
            { text: '„ÇÑ„Å£„Å¶„ÅÑ„Åè', action: () => {
              gameState.shrineTalked = true;
              gameState.canMove = true;
              closeEventDialog();
              // ÂÆüÈöõ„ÅÆ„É™„É≥„ÇØ„Å´Â§âÊõ¥
              window.open('https://yoshimarch.github.io/2026geisyunworldnews/', '_blank', 'noopener,noreferrer');
            }},
            { text: '„ÇÑ„Çâ„Å™„ÅÑ', action: () => {
              showEventDialog({
                speaker: 'Á•û‰∏ª',
                icon: '‚õ©Ô∏è',
                text: '„Åù„ÅÜ„Åã„ÄÅ„Åæ„ÅüÊ∞ó„ÅåÂêë„ÅÑ„Åü„ÇâÊù•„Çã„Åå„Çà„ÅÑ„ÄÇ\n\nÂêàÊ†ºÁ•àÈ°ò„ÄÅ„Åó„Å¶„Åä„Åè„ÅûÔºÅ üôè',
                choices: [{ text: 'ÂÖà„Å´ÈÄ≤„ÇÄ', action: () => {
                  gameState.shrineTalked = true;
                  gameState.canMove = true;
                  closeEventDialog();
                }}]
              });
            }}
          ]
        });
      }, 500);
    }

    // ========== ÈÅéÂéªÂïèÈÅìÂ†¥„Ç§„Éô„É≥„Éà ==========
    function triggerDojoEvent() {
      gameState.canMove = false;
      stopMove();
      showExclamation(document.getElementById('buildingDojo'));

      setTimeout(() => {
        showEventDialog({
          speaker: 'ÈÅìÂ†¥Èï∑',
          icon: 'ü•ã',
          text: '„Åù„Åì„ÅÆËÄÖ„ÄÅÂæÖ„Åü„Çå„ÇàÔºÅ\n\n„Åì„Åì„ÅØÈÅéÂéªÂïèÈÅìÂ†¥„Åò„ÇÉ„ÄÇ\n\nÊ≠£Á≠îÁéá„ÅÆÈõÜË®à„Å´ÂçîÂäõ„Åó„Å¶„Åè„Çå„Å¨„ÅãÔºü\n\nÂêõ„ÅÆÁµêÊûú„ÇíÂÖ•Âäõ„Åó„Å¶„ÇÇ„Çâ„Åà„Çã„Å®„ÄÅ\nÂÖ®‰Ωì„ÅÆÂÇæÂêë„ÅåË¶ã„Åà„Å¶ÁöÜ„ÅÆÂΩπ„Å´Á´ã„Å§„ÅÆ„Åò„ÇÉ„ÄÇ',
          choices: [
            { text: 'ÂçîÂäõ„Åô„Çã', action: dojoCooperateWarning },
            { text: '„ÇÑ„Çâ„Å™„ÅÑ', action: dojoDecline }
          ]
        });
      }, 500);
    }

    function dojoCooperateWarning() {
      showEventDialog({
        speaker: 'ÈÅìÂ†¥Èï∑',
        icon: 'ü•ã',
        text: '„Åä„Åä„ÄÅ„ÅÇ„Çä„Åå„Åü„ÅÑÔºÅ\n\n‚ö†Ô∏è „Åü„Å†„Åó„ÄÅ‰∏Ä„Å§Â§ß‰∫ã„Å™„Åì„Å®„Çí‰ºù„Åà„Å¶„Åä„Åè„ÄÇ\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n„ÄêÂøÖ„Åö„Éã„ÉÉ„ÇØ„Éç„Éº„É†„ÅßÂÖ•Âäõ„Åô„Çã„Åì„Å®„Äë\nÂÆüÂêç„ÅØÁµ∂ÂØæ„Å´ÂÖ•„Çå„Å¶„ÅØ„Å™„Çâ„Å¨„ÅûÔºÅ\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n„Éó„É©„Ç§„Éê„Ç∑„Éº„ÇíÂÆà„Çã„Åì„Å®„ÅåÂ§ßÂàá„Åò„ÇÉ„ÄÇ',
        choices: [
          { text: '„Çè„Åã„Å£„ÅüÔºÅÂÖ•Âäõ„Åô„Çã', action: () => {
            gameState.dojoTalked = true;
            gameState.englishTestDone = true;
            gameState.canMove = true;
            closeEventDialog();
            // ÂÆüÈöõ„ÅÆ„É™„É≥„ÇØ„Å´Â§âÊõ¥
            window.open('https://text-order-project.web.app/', '_blank', 'noopener,noreferrer');
          }},
          { text: '„ÇÑ„Å£„Å±„Çä„ÇÑ„ÇÅ„Çã', action: dojoDecline }
        ]
      });
    }

    function dojoDecline() {
      showEventDialog({
        speaker: 'ÈÅìÂ†¥Èï∑',
        icon: 'ü•ã',
        text: '„Åù„ÅÜ„Åã„ÄÅ„Åæ„ÅüÊ∞ó„ÅåÂêë„ÅÑ„Åü„ÇâÊù•„Çã„Åå„Çà„ÅÑ„ÄÇ\n\nÈÅéÂéªÂïèÊºîÁøí„ÄÅÈ†ëÂºµ„Çã„ÅÆ„Åò„ÇÉ„ÅûÔºÅ üí™',
        choices: [{ text: 'ÂÖà„Å´ÈÄ≤„ÇÄ', action: () => {
          gameState.dojoTalked = true;
          gameState.canMove = true;
          closeEventDialog();
        }}]
      });
    }

    // ========== „Ç≠„Çø„É§„Éû„Ç§„Éô„É≥„Éà ==========
    function triggerKitayamaAppearance() {
      gameState.kitayamaAppeared = true;
      gameState.canMove = false;
      stopMove();

      setTimeout(() => {
        npcKitayama.classList.add('appear');
        
        setTimeout(() => {
          showExclamation(npcKitayama);
        }, 700);

        setTimeout(() => {
          showEventDialog({
            speaker: '„Ç≠„Çø„É§„Éû',
            icon: '‚ú®',
            text: 'Oh...?\n\n„Åù„Åì„ÅÆÂêõ„ÄÅ„Å°„Çá„Å£„Å®ÂæÖ„Å°„Åü„Åæ„Åà„ÄÇ\n\nÁßÅ„ÅÆÂêç„ÅØ„Ç≠„Çø„É§„Éû...\n„Åì„ÅÆÁî∫‰∏ÄÁï™„ÅÆËã±Ë™ûË¨õÂ∏´„Åï„ÄÇ\n\n„Åµ„Åµ„ÄÅÂêõ„ÅÆ„Åù„ÅÆÁõÆ...\nËã±Ë™û„ÅÆÂÆüÂäõ„ÇíÈ´ò„ÇÅ„Åü„ÅÑ„Å®Ë®Ä„Å£„Å¶„ÅÑ„Çã„Å≠Ôºü',
            choices: [{ text: '...„Åà„Å£', action: kitayamaAskTest }]
          });
        }, 1400);
      }, 300);
    }

    function kitayamaAskTest() {
      showEventDialog({
        speaker: '„Ç≠„Çø„É§„Éû',
        icon: 'ü§î',
        text: '„Åù„ÅÆÂâç„Å´‰∏Ä„Å§ËÅû„Åã„Åõ„Å¶„ÇÇ„Çâ„Åä„ÅÜ„ÄÇ\n\nËã±Ë™û„ÅÆ„ÉÜ„Çπ„Éà„Åæ„Åß...\nÈÅéÂéªÂïè„ÅØÁµÇ„Çè„Å£„Å¶„ÅÑ„Çã„Åã„ÅÑÔºü',
        choices: [
          { text: '„ÅØ„ÅÑ„ÄÅÁµÇ„Çè„Çä„Åæ„Åó„Åü', action: kitayamaProposal },
          { text: '„ÅÑ„ÅÑ„Åà„ÄÅ„Åæ„Å†„Åß„Åô', action: kitayamaReject },
          { text: '„ÅÑ„ÇÑ„ÄÅÁßÅ„ÅØÂ∞è6„Åß„Åô', action: kitayamaForElementary }
        ]
      });
    }

    function kitayamaReject() {
      showEventDialog({
        speaker: '„Ç≠„Çø„É§„Éû',
        icon: 'üòè',
        text: '„Åµ„Åµ...\n\n„Åæ„Å†ÁµÇ„Çè„Å£„Å¶„ÅÑ„Å™„ÅÑ„ÅÆ„Åã„ÅÑÔºü\n\n„Åù„Çå„Åß„ÅØ„Åì„Åì„ÇíÈÄö„Åô„Çè„Åë„Å´„ÅØ„ÅÑ„Åã„Å™„ÅÑ„Å™„ÄÇ\n\n„Åæ„Åö„ÅØÈÅéÂéªÂïè„ÇíÁµÇ„Çè„Çâ„Åõ„Å¶„Åè„Çã„Çì„Å†„ÄÇ\nË©±„ÅØ„Åù„Çå„Åã„Çâ„Åï„ÄÇ\n\n‚ú® Stay focused ‚ú®',
        choices: [{ text: '„Çè„Åã„Çä„Åæ„Åó„Åü...', action: () => {
          gameState.kitayamaAppeared = false;
          npcKitayama.classList.remove('appear');
          gameState.canMove = true;
          closeEventDialog();
        }}]
      });
    }

    // ========== Â∞è6Âêë„ÅëÁâπÂà•„É´„Éº„Éà ==========
    function kitayamaForElementary() {
      showEventDialog({
        speaker: '„Ç≠„Çø„É§„Éû',
        icon: '‚ú®',
        text: '„Åä„Åä...Â∞è6„Åã„ÅÑÔºü\n\n„Å§„Åæ„Çä‰∏≠Â≠¶ÂèóÈ®ìÁîü„Å®„ÅÑ„ÅÜ„Çè„Åë„Å†„ÄÇ\n\n„Åµ„Åµ„ÄÅ„Åù„Çå„Å™„ÇâË©±„ÅØÂà•„Å†„ÄÇ\n\nÂêõ„ÅÆ„Çà„ÅÜ„Å™Ëã•„ÅçÊåëÊà¶ËÄÖ„Å´\nÁßÅ„Åã„ÇâÁâπÂà•„Å™„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË¥à„Çç„ÅÜ„ÄÇ',
        choices: [{ text: 'ËÅû„Åã„Åõ„Å¶„Åè„Å†„Åï„ÅÑ', action: kitayamaElementaryMessage }]
      });
    }

    function kitayamaElementaryMessage() {
      showEventDialog({
        speaker: '„Ç≠„Çø„É§„Éû',
        icon: 'üåü',
        text: '‰∏≠Â≠¶ÂèóÈ®ì„ÅØ‰∫∫Áîü„ÅßÊúÄÂàù„ÅÆÂ§ß„Åç„Å™ÊåëÊà¶„Å†„ÄÇ\n\n‰∏çÂÆâ„ÇÇ„ÅÇ„Çã„Å†„Çç„ÅÜ„ÄÇ\n„Åß„ÇÇ„ÄÅ„Åì„Åì„Åæ„ÅßÈ†ëÂºµ„Å£„Å¶„Åç„ÅüÂêõ„Å™„ÇâÂ§ß‰∏àÂ§´„ÄÇ\n\nËá™ÂàÜ„Çí‰ø°„Åò„Å¶„ÄÅÊúÄÂæå„Åæ„ÅßË´¶„ÇÅ„Çã„Å™„ÄÇ\n\n...„ÇÇ„ÅÜÂ∞ë„ÅóËÅû„ÅÑ„Å¶„ÅÑ„Åè„Åã„ÅÑÔºü',
        choices: [
          { text: '„Åæ„Å†ËÅû„Åè', action: kitayamaElementaryGoodEnding },
          { text: 'ËÅû„Åè„ÅÆ„Çí„ÇÑ„ÇÅ„Çã', action: kitayamaElementaryForceChoice, canChange: true }
        ]
      });
    }

    function kitayamaElementaryForceChoice() {
      const noBtn = document.querySelector('.choice-btn.no-btn');
      if (noBtn) {
        noBtn.classList.add('changing');
        setTimeout(() => {
          noBtn.textContent = '„ÇÇ„Å£„Å®ËÅû„Åç„Åü„ÅÑ';
          noBtn.classList.remove('changing');
          noBtn.classList.add('forced');
          noBtn.onclick = kitayamaElementaryLongMessage;
        }, 400);
      }
    }

    function kitayamaElementaryGoodEnding() {
      showEventDialog({
        speaker: '„Ç≠„Çø„É§„Éû',
        icon: 'üí´',
        text: '„Çà„Åó...\n\n„Åù„ÅÆÂßøÂã¢„Åå„ÅÇ„Çå„Å∞Â§ß‰∏àÂ§´„Å†„ÄÇ\n\nÂêõ„ÅÆÂêàÊ†º„ÇíÂøÉ„Åã„ÇâÁ•à„Å£„Å¶„ÅÑ„Çã„Çà„ÄÇ\n\n‚ú® Stay brilliant ‚ú®\n\n...„Åï„ÅÇ„ÄÅË°å„Åç„Åü„Åæ„Åà„ÄÇ\nÊò•„ÅØ„ÇÇ„ÅÜ„Åô„Åê„Åù„Åì„Å†„ÄÇ',
        choices: [{ text: '„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åó„ÅüÔºÅ', action: () => {
          gameState.kitayamaEventDone = true;
          closeEventDialog();
          setTimeout(() => showEnding(), 800);
        }}]
      });
    }

    function kitayamaElementaryLongMessage() {
      showEventDialog({
        speaker: '„Ç≠„Çø„É§„Éû',
        icon: '‚ú®',
        text: '„Åµ„Åµ„ÄÅ„Åù„ÅÜ„Åã„Åù„ÅÜ„Åã...\nËÅû„Åç„Åü„ÅÑ„Åã„ÄÇ„Çà„Çç„Åó„ÅÑ„ÄÇ\n\nÂèóÈ®ì„Å®„ÅÑ„ÅÜ„ÅÆ„ÅØ„Å≠„ÄÅÁµêÊûú„Å†„Åë„Åå„Åô„Åπ„Å¶„Åò„ÇÉ„Å™„ÅÑ„ÄÇ„Åì„ÅÆÁµåÈ®ì„ÅßÂæó„Åü„ÄåÂä™Âäõ„Åô„ÇãÂäõ„Äç„ÄåË´¶„ÇÅ„Å™„ÅÑÂøÉ„Äç„ÄåË®àÁîª„ÇíÁ´ã„Å¶„Å¶ÂÆüË°å„Åô„ÇãÂäõ„Äç...„Åì„Çå„Çâ„ÅØ‰∏ÄÁîü„ÅÆË≤°Áî£„Å´„Å™„Çã„ÄÇ',
        choices: [{ text: '...', action: kitayamaElementaryLongMessage2 }]
      });
    }

    function kitayamaElementaryLongMessage2() {
      showEventDialog({
        speaker: '„Ç≠„Çø„É§„Éû',
        icon: 'üí´',
        text: 'Ë©¶È®ìÂΩìÊó•„ÅØÁ∑äÂºµ„Åô„Çã„Å†„Çç„ÅÜ„ÄÇ„Åß„ÇÇ„ÄÅ„Åù„Çå„ÅØÂêõ„Å†„Åë„Åò„ÇÉ„Å™„ÅÑ„ÄÇÂÖ®Âì°„ÅåÂêå„ÅòÊ∞óÊåÅ„Å°„Å†„ÄÇÊ∑±ÂëºÂê∏„Åó„Å¶„ÄÅ„ÅÑ„Å§„ÇÇÈÄö„Çä„ÅÆËá™ÂàÜ„ÇíÂá∫„Åõ„Å∞„ÅÑ„ÅÑ„ÄÇÂàÜ„Åã„Çâ„Å™„ÅÑÂïèÈ°å„Åå„ÅÇ„Å£„Å¶„ÇÇÁÑ¶„Çã„Å™„ÄÇ„Åß„Åç„ÇãÂïèÈ°å„ÇíÁ¢∫ÂÆü„Å´„ÄÇ',
        choices: [{ text: '...„Å™„Çã„Åª„Å©', action: kitayamaElementaryLongMessage3 }]
      });
    }

    function kitayamaElementaryLongMessage3() {
      showEventDialog({
        speaker: '„Ç≠„Çø„É§„Éû',
        icon: 'üòÖ',
        text: '„Åù„Åó„Å¶‰Ωï„Çà„ÇäÂ§ßÂàá„Å™„ÅÆ„ÅØ...\n\n‰ΩìË™øÁÆ°ÁêÜ„Å†„ÄÇÁù°Áú†„Çí„Åó„Å£„Åã„ÇäÂèñ„Å£„Å¶...\n\nÊâãÊ¥ó„ÅÑ„ÅÜ„Åå„ÅÑ„ÇíÂøò„Çå„Åö„Å´...\n\n......„Åµ„ÅÖ„ÄÇ\n\n...„Åï„Åô„Åå„Å´Âñã„Çä„Åô„Åé„Åü„ÄÇ\n\nÁßÅ„Å®„Åó„Åü„Åì„Å®„Åå...Â∞ë„ÅóÁñ≤„Çå„Åü„Çà...',
        choices: [{ text: '„ÅäÁñ≤„Çå„Åï„Åæ„Åß„Åô...', action: kitayamaElementaryTiredEnding }]
      });
    }

    function kitayamaElementaryTiredEnding() {
      showEventDialog({
        speaker: '„Ç≠„Çø„É§„Éû',
        icon: 'üòå',
        text: '„Åæ„ÅÇ...Âêõ„ÅÆ„Åü„ÇÅ„Å†„Åã„Çâ„Å≠...\n\nÁßÅ„ÅÆË®ÄËëâ„ÄÅÂ∞ë„Åó„Åß„ÇÇÂ±ä„ÅÑ„Å¶„ÅÑ„Çå„Å∞Â¨â„Åó„ÅÑ„ÄÇ\n\n...„Åï„ÅÇ„ÄÅ„ÇÇ„ÅÜË°å„Åç„Å™„Åï„ÅÑ„ÄÇ\n\nÂêàÊ†º„ÇíÁ•à„Å£„Å¶„ÅÑ„Çã„Çà„ÄÇ\n\n‚ú® ...Stay...gorgeous... ‚ú®',
        choices: [{ text: '„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åó„ÅüÔºÅ', action: () => {
          gameState.kitayamaEventDone = true;
          closeEventDialog();
          setTimeout(() => showEnding(), 800);
        }}]
      });
    }

    function kitayamaProposal() {
      showEventDialog({
        speaker: '„Ç≠„Çø„É§„Éû',
        icon: 'üí´',
        text: '„Åä„Åä„ÄÅÁ¥†Êô¥„Çâ„Åó„ÅÑÔºÅ\n\nÂêõ„ÄÅ„Å™„Åã„Å™„Åã„ÇÑ„Çã„Åò„ÇÉ„Å™„ÅÑ„Åã„ÄÇ\n\nÁßÅ„ÅÆYouTube„ÉÅ„É£„É≥„Éç„É´„Åß\nÁâπÂà•„Å™Ëã±Ë™ûËß£Ë™¨ÂãïÁîª„ÇíÂÖ¨Èñã„Åó„Å¶„ÅÑ„Çã„Çì„Å†„ÄÇ\n\nËÅû„ÅÑ„Å¶„ÅÑ„Åè„Åã„ÅÑÔºü\n\n„Åç„Å£„Å®Âêõ„ÅÆËã±Ë™ûÂäõ„Åå...\n‚ú® Ëºù„ÅçÂá∫„Åô ‚ú® „ÅØ„Åö„Åï„ÄÇ',
        choices: [
          { text: 'ËÅû„Åè', action: goToYoutube },
          { text: 'ËÅû„Åã„Å™„ÅÑ', action: kitayamaForceChoice, canChange: true }
        ]
      });
    }

    function kitayamaForceChoice() {
      const noBtn = document.querySelector('.choice-btn.no-btn');
      if (noBtn) {
        noBtn.classList.add('changing');
        
        setTimeout(() => {
          showEventDialog({
            speaker: '„Ç≠„Çø„É§„Éû',
            icon: 'üòè',
            text: '„Åµ„Åµ...\n\n„ÄåËÅû„Åã„Å™„ÅÑ„Äç„Å†„Å£„Å¶Ôºü\n\n...\n\n„Åù„Çì„Å™ÈÅ∏ÊäûËÇ¢...\nÊúÄÂàù„Åã„Çâ„Å™„Åã„Å£„Åü„ÅÆ„Åï„ÄÇ',
            choices: [
              { text: 'ËÅû„Åè', action: goToYoutube },
              { text: 'ËÅû„Åè', action: goToYoutube }
            ]
          });
        }, 400);
      }
    }

    function goToYoutube() {
      showEventDialog({
        speaker: '„Ç≠„Çø„É§„Éû',
        icon: 'üåü',
        text: '„ÅÑ„ÅÑÈÅ∏Êäû„Å†...\n\nÁßÅ„ÅÆÁæé„Åó„ÅÑËß£Ë™¨„ÇíÂ†™ËÉΩ„Åó„Åü„Åæ„Åà„ÄÇ\n\n„Åß„ÅØ„Åæ„Åü‰ºö„Åä„ÅÜ...\n\n‚ú® Stay gorgeous ‚ú®',
        choices: [{ text: 'ÂãïÁîª„ÇíË¶ã„Çã', action: () => {
          gameState.kitayamaEventDone = true;
          closeEventDialog();
          // Â§ß„Åç„ÅÑÂüã„ÇÅËæº„ÅøÂãïÁîª„ÇíË°®Á§∫„ÄÅÈñâ„Åò„ÅüÂæå„Å´„Ç®„É≥„Éá„Ç£„É≥„Ç∞„Å∏
          openVideo(VIDEO_IDS.kitayama, '‚ú® „Ç≠„Çø„É§„Éû„ÅÆËã±Ë™ûËß£Ë™¨ ‚ú®', () => {
            setTimeout(() => showEnding(), 500);
          }, true);  // true = Â§ß„Åç„ÅÑ„É¢„Éº„ÉÄ„É´
        }}]
      });
    }

    // ========== „Ç®„É≥„Éá„Ç£„É≥„Ç∞ ==========
    function showEnding() {
      // BGM„Çí„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà
      if (bgmEnabled && !bgm.paused) {
        let fadeOut = setInterval(() => {
          if (bgm.volume > 0.1) {
            bgm.volume -= 0.1;
          } else {
            bgm.pause();
            clearInterval(fadeOut);
          }
        }, 200);
      }
      endingOverlay.classList.add('active');
    }

    // ========== „Ç§„Éô„É≥„Éà„ÉÄ„Ç§„Ç¢„É≠„Ç∞ ==========
    function showEventDialog(config) {
      gameState.canMove = false;
      stopMove();
      eventOverlay.classList.add('active');
      eventDialog.classList.add('active');
      
      document.getElementById('speakerIcon').textContent = config.icon;
      document.getElementById('speakerName').textContent = config.speaker;
      
      const textEl = document.getElementById('eventText');
      textEl.textContent = '';
      typeWriter(textEl, config.text, 0);

      const choicesEl = document.getElementById('eventChoices');
      choicesEl.innerHTML = '';
      
      config.choices.forEach((choice) => {
        const btn = document.createElement('button');
        btn.className = 'choice-btn' + (choice.canChange ? ' no-btn' : '');
        btn.textContent = choice.text;
        btn.onclick = choice.action;
        choicesEl.appendChild(btn);
      });
    }

    function typeWriter(element, text, index) {
      if (index < text.length) {
        element.textContent += text.charAt(index);
        setTimeout(() => typeWriter(element, text, index + 1), 25);
      }
    }

    function closeEventDialog() {
      eventOverlay.classList.remove('active');
      eventDialog.classList.remove('active');
    }

    // ========== ÊÑüÂòÜÁ¨¶„Ç®„Éï„Çß„ÇØ„Éà ==========
    function showExclamation(element) {
      const rect = element.getBoundingClientRect();
      const excl = document.createElement('div');
      excl.className = 'exclamation';
      excl.textContent = '‚ùó';
      excl.style.left = (rect.left + rect.width / 2 - 17) + 'px';
      excl.style.top = (rect.top - 45) + 'px';
      document.body.appendChild(excl);
      
      setTimeout(() => excl.remove(), 1500);
    }

    // ========== Èõ™„ÉªÊòü„ÅÆÁîüÊàê ==========
    function createSnowflakes() {
      const container = document.getElementById('snowflakes');
      const flakeChars = ['‚ùÑ', '‚ùÖ', '‚ùÜ', '‚Ä¢'];
      
      for (let i = 0; i < 40; i++) {
        const flake = document.createElement('div');
        flake.className = 'snowflake';
        flake.textContent = flakeChars[Math.floor(Math.random() * flakeChars.length)];
        flake.style.left = Math.random() * 100 + '%';
        flake.style.fontSize = (Math.random() * 0.7 + 0.4) + 'em';
        flake.style.animationDuration = (Math.random() * 5 + 6) + 's';
        flake.style.animationDelay = (Math.random() * 10) + 's';
        container.appendChild(flake);
      }
    }

    function createStars() {
      const container = document.getElementById('stars');
      
      for (let i = 0; i < 60; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 100 + '%';
        star.style.animationDelay = (Math.random() * 2) + 's';
        container.appendChild(star);
      }
    }

    // ========== „Ç≠„Éº„Éú„Éº„ÉâÊìç‰ΩúÔºàPCÁî®Ôºâ ==========
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') movePlayer('left');
      else if (e.key === 'ArrowRight') movePlayer('right');
    });

    // ========== BGMÂà∂Âæ° ==========
    const bgm = document.getElementById('bgm');
    const bgmBtn = document.getElementById('bgmBtn');
    const bgmPrompt = document.getElementById('bgmPrompt');
    let bgmEnabled = false;

    // ========== YouTubeÂãïÁîªË®≠ÂÆö ==========
    const VIDEO_IDS = {
      soMuchHappy: 'Rl6WnNdDf4g',  // So much happy„ÅÆÊå®Êã∂ÂãïÁîª
      kitayama: 'XpB7llDefjg'       // „Ç≠„Çø„É§„Éû„ÅÆËã±Ë™ûËß£Ë™¨
    };

    // ========== ÂãïÁîª„É¢„Éº„ÉÄ„É´Âà∂Âæ° ==========
    const videoModal = document.getElementById('videoModal');
    const videoIframe = document.getElementById('videoIframe');
    const videoModalTitle = document.getElementById('videoModalTitle');
    let videoCallback = null;

    function openVideo(videoId, title, callback, isLarge = false) {
      // BGM„Çí‰∏ÄÊôÇÂÅúÊ≠¢
      if (bgmEnabled && !bgm.paused) {
        bgm.pause();
      }
      
      videoModalTitle.textContent = title || 'üì∫ ÂãïÁîª„ÇíË¶ã„Çã';
      videoIframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
      
      // Â§ß„Åç„ÅÑ„É¢„Éº„ÉÄ„É´„Åã„Å©„ÅÜ„Åã
      if (isLarge) {
        videoModal.classList.add('large');
      } else {
        videoModal.classList.remove('large');
      }
      
      videoModal.classList.add('active');
      videoCallback = callback;
    }

    function closeVideo() {
      videoIframe.src = '';
      videoModal.classList.remove('active');
      videoModal.classList.remove('large');
      
      // BGM„ÇíÂÜçÈñã
      if (bgmEnabled) {
        bgm.play().catch(e => console.log('BGMÂÜçÁîü„Ç®„É©„Éº:', e));
      }
      
      // „Ç≥„Éº„É´„Éê„ÉÉ„ÇØÂÆüË°å
      if (videoCallback) {
        videoCallback();
        videoCallback = null;
      }
    }

    function startWithBGM() {
      bgmEnabled = true;
      bgm.volume = 0.5; // Èü≥Èáè50%
      bgm.play().catch(e => console.log('BGMÂÜçÁîü„Ç®„É©„Éº:', e));
      bgmBtn.textContent = 'üîä BGM';
      bgmBtn.classList.add('playing');
      bgmPrompt.classList.add('hidden');
    }

    function startWithoutBGM() {
      bgmEnabled = false;
      bgmPrompt.classList.add('hidden');
    }

    function toggleBGM() {
      if (bgm.paused) {
        bgm.play().catch(e => console.log('BGMÂÜçÁîü„Ç®„É©„Éº:', e));
        bgmBtn.textContent = 'üîä BGM';
        bgmBtn.classList.add('playing');
        bgmEnabled = true;
      } else {
        bgm.pause();
        bgmBtn.textContent = 'üîá BGM';
        bgmBtn.classList.remove('playing');
        bgmEnabled = false;
      }
    }

    // ========== ÂàùÊúüÂåñ ==========
    function init() {
      createSnowflakes();
      createStars();
      player.style.left = gameState.playerX + '%';
      horse.classList.add('flip');
    }

    init();
  </script>
</body>
</html>
