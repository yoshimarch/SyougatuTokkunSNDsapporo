
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>æ­£æœˆç‰¹è¨“ã®ç”º - 2026</title>
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none !important;
      -webkit-user-select: none !important;
      -khtml-user-select: none !important;
      -moz-user-select: none !important;
      -ms-user-select: none !important;
      user-select: none !important;
    }

    html, body {
      touch-action: manipulation;
      -webkit-touch-callout: none !important;
      overscroll-behavior: none;
      -webkit-user-drag: none;
      -webkit-text-size-adjust: none;
    }

    img, a, div, button, span {
      -webkit-touch-callout: none !important;
      -webkit-user-select: none !important;
      pointer-events: auto;
    }

    :root {
      --snow-bg: #1a1a2e;
      --ground-color: #e8f4f8;
      --building-warm: #ffd93d;
      --text-color: #fff;
    }

    body {
      background: linear-gradient(180deg, #0f0f23 0%, #1a1a3e 50%, #2d2d5a 100%);
      min-height: 100vh;
      overflow: hidden;
      font-family: 'DotGothic16', sans-serif;
      image-rendering: pixelated;
      touch-action: manipulation;
      user-select: none;
      -webkit-user-select: none;
    }

    /* é›ªã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .snowflakes {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 100;
      overflow: hidden;
    }

    .snowflake {
      position: absolute;
      color: #fff;
      font-size: 1em;
      text-shadow: 0 0 5px #fff;
      animation: fall linear infinite;
      opacity: 0.8;
    }

    @keyframes fall {
      0% { transform: translateY(-10vh) translateX(0); opacity: 1; }
      100% { transform: translateY(110vh) translateX(50px); opacity: 0.3; }
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
    .game-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }

    /* ã‚¿ãƒƒãƒ—ã‚¨ãƒªã‚¢ï¼ˆå·¦å³ç§»å‹•ç”¨ï¼‰ */
    .tap-area {
      position: fixed;
      top: 0;
      width: 50%;
      height: 100%;
      z-index: 50;
      cursor: pointer;
    }

    .tap-area.left { left: 0; }
    .tap-area.right { right: 0; }

    .tap-indicator {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      font-size: 40px;
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
    }

    .tap-area.left .tap-indicator { left: 20px; }
    .tap-area.right .tap-indicator { right: 20px; }

    .tap-area:active .tap-indicator { opacity: 0.5; }

    /* èƒŒæ™¯ã®å±±ã€… */
    .mountains {
      position: absolute;
      bottom: 180px;
      left: 0;
      width: 200%;
      height: 200px;
      z-index: 1;
    }

    .mountain {
      position: absolute;
      bottom: 0;
      width: 0;
      height: 0;
      border-style: solid;
    }

    .mountain-1 { left: 5%; border-width: 0 80px 120px 80px; border-color: transparent transparent #3d3d6b transparent; }
    .mountain-2 { left: 20%; border-width: 0 120px 180px 120px; border-color: transparent transparent #2d2d5a transparent; }
    .mountain-3 { left: 50%; border-width: 0 100px 150px 100px; border-color: transparent transparent #3d3d6b transparent; }
    .mountain-4 { left: 75%; border-width: 0 90px 130px 90px; border-color: transparent transparent #2d2d5a transparent; }

    /* åœ°é¢ */
    .ground {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 180px;
      background: linear-gradient(180deg, #c8e6f0 0%, #e8f4f8 30%, #fff 100%);
      z-index: 2;
    }

    /* ç”ºã‚¨ãƒªã‚¢ */
    .town {
      position: absolute;
      bottom: 60px;
      left: 0;
      width: 100%;
      height: 300px;
      z-index: 10;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 80px;
      padding: 0 20px;
    }

    /* å»ºç‰©å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
    .building {
      position: relative;
      cursor: pointer;
      transition: transform 0.2s ease;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3));
      z-index: 20;
    }

    .building:active {
      transform: translateY(-5px) scale(1.02);
    }

    .building-glow {
      position: absolute;
      bottom: -20px;
      left: 50%;
      transform: translateX(-50%);
      width: 120%;
      height: 40px;
      background: radial-gradient(ellipse at center, rgba(255, 217, 61, 0.4) 0%, transparent 70%);
      opacity: 0.5;
    }

    /* éå»å•é“å ´ */
    .dojo {
      width: 140px;
    }

    .dojo-body {
      width: 140px;
      height: 110px;
      background: linear-gradient(180deg, #8b4513 0%, #654321 100%);
      border: 4px solid #3d2914;
      position: relative;
    }

    .dojo-roof {
      width: 160px;
      height: 55px;
      background: #1a1a2e;
      position: relative;
      left: -10px;
      clip-path: polygon(0% 100%, 50% 0%, 100% 100%);
    }

    .dojo-roof::after {
      content: '';
      position: absolute;
      top: 5px;
      left: 50%;
      transform: translateX(-50%);
      width: 150px;
      height: 50px;
      background: #2d2d4a;
      clip-path: polygon(0% 100%, 50% 0%, 100% 100%);
    }

    .dojo-window {
      position: absolute;
      width: 35px;
      height: 45px;
      background: var(--building-warm);
      border: 3px solid #3d2914;
      top: 20px;
      box-shadow: 0 0 20px rgba(255, 217, 61, 0.6);
    }

    .dojo-window.left { left: 15px; }
    .dojo-window.right { right: 15px; }

    .dojo-door {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 55px;
      background: #2d1810;
      border: 3px solid #1a0f0a;
    }

    .dojo-sign {
      position: absolute;
      top: -85px;
      left: 50%;
      transform: translateX(-50%);
      background: #8b4513;
      color: #fff;
      padding: 8px 12px;
      font-size: 12px;
      border: 3px solid #3d2914;
      white-space: nowrap;
    }

    /* ç¥ç¤¾ï¼ˆæ™‚äº‹å•é¡Œï¼‰ */
    .shrine {
      width: 150px;
    }

    .torii {
      width: 120px;
      height: 80px;
      position: relative;
      margin: 0 auto 10px;
    }

    .torii-top {
      position: absolute;
      top: 0;
      left: -15px;
      width: 150px;
      height: 18px;
      background: #c41e3a;
      border-radius: 3px;
    }

    .torii-beam {
      position: absolute;
      top: 25px;
      left: 0;
      width: 120px;
      height: 12px;
      background: #c41e3a;
    }

    .torii-pillar {
      position: absolute;
      top: 18px;
      width: 14px;
      height: 62px;
      background: #c41e3a;
    }

    .torii-pillar.left { left: 12px; }
    .torii-pillar.right { right: 12px; }

    .shrine-body {
      width: 150px;
      height: 90px;
      background: linear-gradient(180deg, #f5f5f5 0%, #e0e0e0 100%);
      border: 4px solid #bbb;
      position: relative;
    }

    .shrine-roof {
      width: 170px;
      height: 50px;
      background: #2d4a2d;
      position: relative;
      left: -10px;
      clip-path: polygon(0% 100%, 10% 0%, 90% 0%, 100% 100%);
    }

    .shrine-door {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 45px;
      height: 55px;
      background: #8b4513;
      border: 3px solid #654321;
    }

    .shrine-lantern {
      position: absolute;
      bottom: 65px;
      width: 22px;
      height: 32px;
      background: #ff6b6b;
      border-radius: 5px;
      box-shadow: 0 0 20px rgba(255, 107, 107, 0.8);
      animation: lanternGlow 2s ease-in-out infinite alternate;
    }

    @keyframes lanternGlow {
      0% { box-shadow: 0 0 15px rgba(255, 107, 107, 0.6); }
      100% { box-shadow: 0 0 25px rgba(255, 107, 107, 1); }
    }

    .shrine-lantern.left { left: 15px; }
    .shrine-lantern.right { right: 15px; }

    .shrine-sign {
      position: absolute;
      top: -85px;
      left: 50%;
      transform: translateX(-50%);
      background: #f5f5dc;
      color: #333;
      padding: 8px 12px;
      font-size: 12px;
      border: 3px solid #8b4513;
      white-space: nowrap;
    }

    /* æœ¨ã€… */
    .tree {
      position: absolute;
      z-index: 5;
    }

    .tree-trunk {
      width: 20px;
      height: 40px;
      background: #4a3728;
      margin: 0 auto;
    }

    .tree-snow {
      width: 60px;
      height: 80px;
      background: radial-gradient(ellipse at center, #e8f4f8 0%, #c8dae8 100%);
      border-radius: 50%;
      position: relative;
      left: -20px;
    }

    .tree-snow::before {
      content: '';
      position: absolute;
      top: -30px;
      left: 10px;
      width: 40px;
      height: 50px;
      background: radial-gradient(ellipse at center, #e8f4f8 0%, #c8dae8 100%);
      border-radius: 50%;
    }

    .tree.t1 { left: 3%; bottom: 200px; transform: scale(0.8); }
    .tree.t2 { right: 3%; bottom: 210px; transform: scale(0.9); }

    /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆé¦¬ï¼‰ */
    .player {
      position: absolute;
      bottom: 100px;
      left: 88%;
      transform: translateX(-50%);
      z-index: 60;
      transition: left 0.2s ease-out;
    }

    .horse {
      font-size: 56px;
      filter: drop-shadow(0 5px 10px rgba(0,0,0,0.3));
      animation: horseIdle 0.5s ease-in-out infinite alternate;
    }

    .horse.flip {
      transform: scaleX(-1);
    }

    .horse.walking {
      animation: horseWalk 0.15s steps(2) infinite;
    }

    @keyframes horseIdle {
      0% { transform: translateY(0); }
      100% { transform: translateY(-3px); }
    }

    @keyframes horseWalk {
      0% { transform: translateY(0) rotate(-2deg); }
      50% { transform: translateY(-5px) rotate(2deg); }
      100% { transform: translateY(0) rotate(-2deg); }
    }

    /* UIè¦ç´  */
    .ui-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 200;
      padding: 15px;
      pointer-events: none;
    }

    .title-box {
      background: rgba(0, 0, 0, 0.85);
      border: 4px solid #ffd93d;
      padding: 12px 20px;
      display: inline-block;
      position: relative;
    }

    .title-box h1 {
      color: #ffd93d;
      font-size: 22px;
      text-shadow: 2px 2px 0 #000;
      margin-bottom: 3px;
    }

    .title-box .subtitle {
      color: #fff;
      font-size: 11px;
    }

    .title-box .year-badge {
      position: absolute;
      top: -12px;
      right: -12px;
      background: #c41e3a;
      color: #fff;
      padding: 4px 8px;
      font-size: 11px;
      border: 2px solid #ffd93d;
    }

    .controls-hint {
      background: rgba(0, 0, 0, 0.7);
      border: 2px solid #888;
      padding: 8px 12px;
      margin-top: 8px;
      display: inline-block;
    }

    .controls-hint p {
      color: #ccc;
      font-size: 11px;
      margin: 2px 0;
    }

    /* æ˜Ÿç©º */
    .stars {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 60%;
      z-index: 0;
    }

    .star {
      position: absolute;
      width: 3px;
      height: 3px;
      background: #fff;
      border-radius: 50%;
      animation: twinkle 2s ease-in-out infinite;
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }

    /* è¡—ç¯ */
    .lamp-post {
      position: absolute;
      z-index: 8;
    }

    .lamp-pole {
      width: 8px;
      height: 80px;
      background: #333;
      margin: 0 auto;
    }

    .lamp-light {
      width: 25px;
      height: 20px;
      background: #ffd93d;
      border-radius: 5px 5px 10px 10px;
      position: relative;
      left: -8px;
      box-shadow: 0 0 30px rgba(255, 217, 61, 0.8), 0 0 60px rgba(255, 217, 61, 0.4);
    }

    .lamp-post.l1 { left: 15%; bottom: 180px; }
    .lamp-post.l2 { right: 15%; bottom: 180px; }

    /* é–€æ¾ */
    .kadomatsu {
      position: absolute;
      font-size: 45px;
      z-index: 15;
    }

    .kadomatsu.k1 { left: 1%; bottom: 180px; }
    .kadomatsu.k2 { right: 1%; bottom: 180px; }

    /* ========== NPCã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ ========== */
    .npc {
      position: absolute;
      z-index: 45;
      cursor: pointer;
    }

    /* So much happy */
    .npc-kitataya {
      bottom: 95px;
      right: 22%;
    }

    .kitataya-head {
      width: 38px;
      height: 38px;
      background: #ffd5b5;
      border-radius: 50%;
      margin: 0 auto;
      position: relative;
      border: 2px solid #d4a574;
    }

    .kitataya-hair {
      position: absolute;
      top: -5px;
      left: -3px;
      width: 44px;
      height: 28px;
      background: #2d2d2d;
      border-radius: 50% 50% 0 0;
    }

    .kitataya-eyes {
      position: absolute;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
    }

    .kitataya-eye {
      width: 5px;
      height: 5px;
      background: #000;
      border-radius: 50%;
    }

    .kitataya-smile {
      position: absolute;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      width: 14px;
      height: 7px;
      border: 2px solid #c41e3a;
      border-top: none;
      border-radius: 0 0 10px 10px;
    }

    .kitataya-body {
      width: 32px;
      height: 38px;
      background: linear-gradient(180deg, #4a90d9 0%, #3a7bc8 100%);
      margin: 0 auto;
      border-radius: 5px 5px 0 0;
      position: relative;
    }

    .kitataya-tie {
      position: absolute;
      top: 2px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 10px solid #c41e3a;
    }

    .npc-name {
      position: absolute;
      bottom: -28px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.85);
      color: #7fff7f;
      padding: 4px 10px;
      font-size: 10px;
      white-space: nowrap;
      border: 2px solid #7fff7f;
    }

    /* ã‚­ã‚¿ãƒ¤ãƒ (ãƒ¡ã‚¿ãƒˆãƒ³é¢¨) */
    .npc-kitayama {
      bottom: 95px;
      left: -100px;
      transition: left 1s ease-out;
    }

    .npc-kitayama.appear {
      left: 8%;
    }

    .kitayama-head {
      width: 34px;
      height: 40px;
      background: linear-gradient(180deg, #ffd5b5 0%, #f0c5a5 100%);
      margin: 0 auto;
      position: relative;
      border: 2px solid #d4a574;
      border-radius: 5px 5px 10px 10px;
    }

    .kitayama-hair {
      position: absolute;
      top: -10px;
      left: -6px;
      width: 46px;
      height: 32px;
      background: linear-gradient(180deg, #1a1a1a 0%, #333 100%);
      clip-path: polygon(10% 100%, 0% 40%, 20% 0%, 80% 0%, 100% 40%, 90% 100%, 70% 80%, 50% 100%, 30% 80%);
    }

    .kitayama-eyes {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 12px;
    }

    .kitayama-eye {
      width: 6px;
      height: 3px;
      background: #000;
      border-radius: 0 0 3px 3px;
    }

    .kitayama-sparkle {
      position: absolute;
      top: 8px;
      right: -2px;
      font-size: 12px;
      animation: sparkle 1s ease-in-out infinite;
    }

    @keyframes sparkle {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.3); }
    }

    .kitayama-smirk {
      position: absolute;
      bottom: 8px;
      left: 55%;
      transform: translateX(-50%);
      width: 12px;
      height: 5px;
      border: 2px solid #333;
      border-top: none;
      border-left: none;
      border-radius: 0 0 6px 0;
    }

    .kitayama-body {
      width: 30px;
      height: 48px;
      background: linear-gradient(180deg, #1a1a1a 0%, #333 100%);
      margin: 0 auto;
      position: relative;
      clip-path: polygon(0% 0%, 100% 0%, 90% 100%, 10% 100%);
    }

    .kitayama-collar {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 22px;
      height: 10px;
      background: #fff;
      clip-path: polygon(0% 0%, 100% 0%, 80% 100%, 20% 100%);
    }

    .kitayama-legs {
      display: flex;
      justify-content: center;
      gap: 5px;
    }

    .kitayama-leg {
      width: 9px;
      height: 16px;
      background: #1a1a1a;
    }

    /* ã‚¤ãƒ™ãƒ³ãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    .event-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0);
      z-index: 280;
      pointer-events: none;
      transition: background 0.3s;
    }

    .event-overlay.active {
      background: rgba(0, 0, 0, 0.4);
      pointer-events: auto;
    }

    /* ã‚¤ãƒ™ãƒ³ãƒˆãƒ€ã‚¤ã‚¢ãƒ­ã‚° */
    .event-dialog {
      position: fixed;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      width: 94%;
      max-width: 600px;
      background: #000;
      border: 4px solid #fff;
      z-index: 350;
      display: none;
    }

    .event-dialog.active {
      display: block;
      animation: dialogAppear 0.2s ease-out;
    }

    @keyframes dialogAppear {
      0% { transform: translateX(-50%) scale(0.9); opacity: 0; }
      100% { transform: translateX(-50%) scale(1); opacity: 1; }
    }

    .event-dialog-header {
      background: #222;
      padding: 10px 15px;
      border-bottom: 2px solid #444;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .speaker-icon { font-size: 28px; }
    .speaker-name { color: #ffd93d; font-size: 15px; }

    .event-dialog-content {
      padding: 18px;
      min-height: 80px;
    }

    .event-dialog-content p {
      color: #fff;
      font-size: 15px;
      line-height: 1.8;
    }

    .event-dialog-choices {
      padding: 12px 18px;
      display: flex;
      gap: 12px;
      justify-content: center;
      border-top: 2px solid #333;
      flex-wrap: wrap;
    }

    .choice-btn {
      background: #222;
      border: 3px solid #ffd93d;
      color: #ffd93d;
      padding: 14px 28px;
      font-family: 'DotGothic16', sans-serif;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.15s ease;
      min-width: 120px;
    }

    .choice-btn:active {
      background: #ffd93d;
      color: #000;
      transform: scale(0.95);
    }

    .choice-btn.changing {
      animation: buttonShake 0.4s ease;
    }

    @keyframes buttonShake {
      0%, 100% { transform: translateX(0); }
      20% { transform: translateX(-8px) rotate(-2deg); }
      40% { transform: translateX(8px) rotate(2deg); }
      60% { transform: translateX(-6px) rotate(-1deg); }
      80% { transform: translateX(6px) rotate(1deg); }
    }

    .choice-btn.forced {
      background: #c41e3a;
      border-color: #ff6b6b;
      color: #fff;
    }

    /* æ„Ÿå˜†ç¬¦ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
    .exclamation {
      position: fixed;
      font-size: 35px;
      color: #ff0;
      text-shadow: 0 0 10px #ff0, 2px 2px 0 #000;
      animation: exclamationPop 0.5s ease-out;
      z-index: 400;
      pointer-events: none;
    }

    @keyframes exclamationPop {
      0% { transform: scale(0) translateY(20px); opacity: 0; }
      50% { transform: scale(1.4) translateY(-10px); opacity: 1; }
      100% { transform: scale(1) translateY(0); opacity: 1; }
    }

    /* ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚° */
    .ending-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0);
      z-index: 500;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      opacity: 0;
      transition: all 1s ease;
    }

    .ending-overlay.active {
      background: rgba(0, 0, 0, 0.9);
      opacity: 1;
      pointer-events: auto;
    }

    .ending-horse {
      font-size: 100px;
      animation: endingSpin 2s linear infinite;
      margin-bottom: 30px;
    }

    @keyframes endingSpin {
      0% { transform: rotate(0deg) scale(1); }
      25% { transform: rotate(90deg) scale(1.1); }
      50% { transform: rotate(180deg) scale(1.2); }
      75% { transform: rotate(270deg) scale(1.1); }
      100% { transform: rotate(360deg) scale(1); }
    }

    .ending-message {
      color: #ffd93d;
      font-size: 32px;
      text-align: center;
      text-shadow: 3px 3px 0 #000;
      animation: endingFade 1s ease-out 0.5s both;
      padding: 0 20px;
    }

    .ending-submessage {
      color: #fff;
      font-size: 18px;
      margin-top: 25px;
      text-align: center;
      line-height: 1.8;
      animation: endingFade 1s ease-out 1.5s both;
    }

    @keyframes endingFade {
      0% { opacity: 0; transform: translateY(20px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    .ending-restart {
      margin-top: 50px;
      background: #ffd93d;
      color: #000;
      border: none;
      padding: 18px 50px;
      font-family: 'DotGothic16', sans-serif;
      font-size: 18px;
      cursor: pointer;
      animation: endingFade 1s ease-out 2.5s both;
      border-radius: 5px;
    }

    .ending-restart:active {
      transform: scale(0.95);
      background: #fff;
    }

    /* BGMã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
    .bgm-control {
      position: fixed;
      top: 15px;
      right: 15px;
      z-index: 250;
    }

    .bgm-btn {
      background: rgba(0, 0, 0, 0.7);
      border: 2px solid #ffd93d;
      color: #ffd93d;
      padding: 8px 15px;
      font-family: 'DotGothic16', sans-serif;
      font-size: 12px;
      cursor: pointer;
      border-radius: 5px;
      transition: all 0.2s;
    }

    .bgm-btn:active {
      background: #ffd93d;
      color: #000;
    }

    .bgm-btn.playing {
      background: rgba(255, 217, 61, 0.3);
    }

    /* BGMé–‹å§‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ */
    .bgm-prompt {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 600;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 1;
      transition: opacity 0.5s;
    }

    .bgm-prompt.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .bgm-prompt-content {
      text-align: center;
    }

    .bgm-prompt-title {
      color: #ffd93d;
      font-size: 28px;
      margin-bottom: 20px;
      text-shadow: 2px 2px 0 #000;
    }

    .bgm-prompt-horse {
      font-size: 80px;
      margin-bottom: 30px;
      animation: horseIdle 0.5s ease-in-out infinite alternate;
    }

    .bgm-prompt-text {
      color: #fff;
      font-size: 14px;
      margin-bottom: 30px;
    }

    .bgm-prompt-btn {
      background: #ffd93d;
      border: none;
      color: #000;
      padding: 18px 50px;
      font-family: 'DotGothic16', sans-serif;
      font-size: 18px;
      cursor: pointer;
      border-radius: 5px;
      margin: 10px;
      transition: transform 0.1s;
    }

    .bgm-prompt-btn:active {
      transform: scale(0.95);
    }

    .bgm-prompt-btn.secondary {
      background: #333;
      color: #fff;
      border: 2px solid #666;
    }

    /* YouTubeåŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .video-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 700;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .video-modal.active {
      display: flex;
    }

    .video-modal-header {
      color: #ffd93d;
      font-size: 18px;
      margin-bottom: 15px;
      text-align: center;
    }

    .video-container {
      width: 100%;
      max-width: 800px;
      aspect-ratio: 16 / 9;
      background: #000;
      border: 4px solid #ffd93d;
      border-radius: 8px;
      overflow: hidden;
    }

    .video-container iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* å¤§ãã„å‹•ç”»ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚­ã‚¿ãƒ¤ãƒè‹±èªè§£èª¬ç”¨ï¼‰ */
    .video-modal.large .video-container {
      max-width: 95vw;
      max-height: 80vh;
      width: 95vw;
      height: 80vh;
      aspect-ratio: auto;
    }

    .video-modal.large .video-modal-header {
      font-size: 22px;
      margin-bottom: 10px;
    }

    .video-close-btn {
      margin-top: 20px;
      background: #ffd93d;
      border: none;
      color: #000;
      padding: 15px 40px;
      font-family: 'DotGothic16', sans-serif;
      font-size: 16px;
      cursor: pointer;
      border-radius: 5px;
    }

    .video-close-btn:active {
      transform: scale(0.95);
      background: #fff;
    }

    .video-modal.large .video-close-btn {
      margin-top: 15px;
      padding: 18px 50px;
      font-size: 18px;
    }

    /* å¤–éƒ¨ã‚µã‚¤ãƒˆåŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .site-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 700;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 5px;
    }

    .site-modal.active {
      display: flex;
    }

    .site-modal-header {
      color: #ffd93d;
      font-size: 16px;
      margin-bottom: 5px;
      text-align: center;
      flex-shrink: 0;
    }

    .site-container {
      width: 100%;
      flex: 1;
      background: #fff;
      border: 3px solid #ffd93d;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }

    /* iframeã‚’ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã—ã¦å…¨ä½“è¡¨ç¤º */
    .site-container iframe {
      width: 166%;
      height: 166%;
      border: none;
      transform: scale(0.6);
      transform-origin: top left;
      -webkit-touch-callout: none !important;
    }

    .site-close-btn {
      margin-top: 5px;
      background: #ffd93d;
      border: none;
      color: #000;
      padding: 12px 40px;
      font-family: 'DotGothic16', sans-serif;
      font-size: 14px;
      cursor: pointer;
      border-radius: 5px;
      flex-shrink: 0;
    }

    .site-close-btn:active {
      transform: scale(0.95);
      background: #fff;
    }
  </style>
</head>
<body>
  <!-- BGM -->
  <audio id="bgm" loop>
    <source src="bgm2.mp3" type="audio/mpeg">
  </audio>

  <!-- BGMã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
  <div class="bgm-control" id="bgmControl">
    <button class="bgm-btn" id="bgmBtn" onclick="toggleBGM()">ğŸ”‡ BGM</button>
  </div>

  <!-- æ˜Ÿç©º -->
  <div class="stars" id="stars"></div>

  <!-- é›ª -->
  <div class="snowflakes" id="snowflakes"></div>

  <!-- ã‚¿ãƒƒãƒ—ã‚¨ãƒªã‚¢ -->
  <div class="tap-area left" id="tapLeft">
    <div class="tap-indicator">â—€</div>
  </div>
  <div class="tap-area right" id="tapRight">
    <div class="tap-indicator">â–¶</div>
  </div>

  <!-- ã‚¤ãƒ™ãƒ³ãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div class="event-overlay" id="eventOverlay"></div>

  <div class="game-container">
    <!-- å±±ã€… -->
    <div class="mountains">
      <div class="mountain mountain-1"></div>
      <div class="mountain mountain-2"></div>
      <div class="mountain mountain-3"></div>
      <div class="mountain mountain-4"></div>
    </div>

    <!-- æœ¨ã€… -->
    <div class="tree t1">
      <div class="tree-snow"></div>
      <div class="tree-trunk"></div>
    </div>
    <div class="tree t2">
      <div class="tree-snow"></div>
      <div class="tree-trunk"></div>
    </div>

    <!-- è¡—ç¯ -->
    <div class="lamp-post l1">
      <div class="lamp-light"></div>
      <div class="lamp-pole"></div>
    </div>
    <div class="lamp-post l2">
      <div class="lamp-light"></div>
      <div class="lamp-pole"></div>
    </div>

    <!-- é–€æ¾ -->
    <div class="kadomatsu k1">ğŸ</div>
    <div class="kadomatsu k2">ğŸ</div>

    <!-- åœ°é¢ -->
    <div class="ground"></div>

    <!-- NPC: So much happy -->
    <div class="npc npc-kitataya" id="npcKitataya">
      <div class="kitataya-head">
        <div class="kitataya-hair"></div>
        <div class="kitataya-eyes">
          <div class="kitataya-eye"></div>
          <div class="kitataya-eye"></div>
        </div>
        <div class="kitataya-smile"></div>
      </div>
      <div class="kitataya-body">
        <div class="kitataya-tie"></div>
      </div>
      <div class="npc-name">So much happy</div>
    </div>

    <!-- NPC: ã‚­ã‚¿ãƒ¤ãƒ -->
    <div class="npc npc-kitayama" id="npcKitayama">
      <div class="kitayama-head">
        <div class="kitayama-hair"></div>
        <div class="kitayama-eyes">
          <div class="kitayama-eye"></div>
          <div class="kitayama-eye"></div>
        </div>
        <div class="kitayama-sparkle">âœ¨</div>
        <div class="kitayama-smirk"></div>
      </div>
      <div class="kitayama-body">
        <div class="kitayama-collar"></div>
      </div>
      <div class="kitayama-legs">
        <div class="kitayama-leg"></div>
        <div class="kitayama-leg"></div>
      </div>
      <div class="npc-name">ã‚­ã‚¿ãƒ¤ãƒ</div>
    </div>

    <!-- ç”ºã®å»ºç‰© -->
    <div class="town">
      <!-- éå»å•é“å ´ -->
      <div class="building dojo" id="buildingDojo">
        <div class="building-glow"></div>
        <div class="dojo-sign">ğŸ¥‹ éå»å•é“å ´</div>
        <div class="dojo-roof"></div>
        <div class="dojo-body">
          <div class="dojo-window left"></div>
          <div class="dojo-window right"></div>
          <div class="dojo-door"></div>
        </div>
      </div>

      <!-- ç¥ç¤¾ï¼ˆæ™‚äº‹å•é¡Œï¼‰ -->
      <div class="building shrine" id="buildingShrine">
        <div class="building-glow"></div>
        <div class="shrine-sign">â›©ï¸ æ™‚äº‹å•é¡Œç¥ç¤¾</div>
        <div class="torii">
          <div class="torii-top"></div>
          <div class="torii-beam"></div>
          <div class="torii-pillar left"></div>
          <div class="torii-pillar right"></div>
        </div>
        <div class="shrine-roof"></div>
        <div class="shrine-body">
          <div class="shrine-lantern left"></div>
          <div class="shrine-lantern right"></div>
          <div class="shrine-door"></div>
        </div>
      </div>
    </div>

    <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ -->
    <div class="player" id="player">
      <div class="horse" id="horse">ğŸ´</div>
    </div>
  </div>

  <!-- UI -->
  <div class="ui-overlay">
    <div class="title-box">
      <div class="year-badge">ğŸ´ 2026</div>
      <h1>æ­£æœˆç‰¹è¨“ã®ç”º</h1>
      <div class="subtitle">ã€œ åˆæ ¼ã‚’ç›®æŒ‡ã™å†’é™ºã¸ ã€œ</div>
    </div>
    <div class="controls-hint">
      <p>ğŸ“± ç”»é¢ã®å·¦å³ã‚’ã‚¿ãƒƒãƒ—ã§ç§»å‹•</p>
      <p>ğŸ  å»ºç‰©ã‚„ã‚­ãƒ£ãƒ©ã‚’ã‚¿ãƒƒãƒ—ã§ä¼šè©±</p>
    </div>
  </div>

  <!-- ã‚¤ãƒ™ãƒ³ãƒˆãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
  <div class="event-dialog" id="eventDialog">
    <div class="event-dialog-header">
      <span class="speaker-icon" id="speakerIcon">ğŸ˜Š</span>
      <span class="speaker-name" id="speakerName">???</span>
    </div>
    <div class="event-dialog-content">
      <p id="eventText"></p>
    </div>
    <div class="event-dialog-choices" id="eventChoices"></div>
  </div>

  <!-- YouTubeåŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="video-modal" id="videoModal">
    <div class="video-modal-header" id="videoModalTitle">ğŸ“º å‹•ç”»ã‚’è¦‹ã‚‹</div>
    <div class="video-container">
      <iframe id="videoIframe" src="" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe>
    </div>
    <button class="video-close-btn" onclick="closeVideo()">âœ• é–‰ã˜ã¦é€²ã‚€</button>
  </div>

  <!-- å¤–éƒ¨ã‚µã‚¤ãƒˆåŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="site-modal" id="siteModal">
    <div class="site-modal-header" id="siteModalTitle">ğŸ“ å¤–éƒ¨ã‚µã‚¤ãƒˆ</div>
    <div class="site-container">
      <iframe id="siteIframe" src=""></iframe>
    </div>
    <button class="site-close-btn" onclick="closeSite()">âœ• é–‰ã˜ã¦ã‚²ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
  </div>

  <!-- BGMé–‹å§‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ -->
  <div class="bgm-prompt" id="bgmPrompt">
    <div class="bgm-prompt-content">
      <div class="bgm-prompt-title">ğŸ æ­£æœˆç‰¹è¨“ã®ç”º ğŸ</div>
      <div class="bgm-prompt-horse">ğŸ´</div>
      <div class="bgm-prompt-text">BGMã‚’å†ç”Ÿã—ã¾ã™ã‹ï¼Ÿ</div>
      <button class="bgm-prompt-btn" onclick="startWithBGM()">ğŸ”Š BGMã‚ã‚Š</button>
      <button class="bgm-prompt-btn secondary" onclick="startWithoutBGM()">ğŸ”‡ BGMãªã—</button>
    </div>
  </div>

  <!-- ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚° -->
  <div class="ending-overlay" id="endingOverlay">
    <div class="ending-horse">ğŸ´</div>
    <div class="ending-message">ğŸ 2026å¹´ã‚‚é ‘å¼µã‚ã†ï¼ ğŸ</div>
    <div class="ending-submessage">
      æ­£æœˆç‰¹è¨“ã€ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼<br>
      åˆæ ¼ç›®æŒ‡ã—ã¦é§†ã‘æŠœã‘ã‚ˆã†ï¼<br><br>
      ğŸŒ¸ æ˜¥ã¯ã‚‚ã†ã™ããã“ã ï¼ ğŸŒ¸
    </div>
    <button class="ending-restart" onclick="location.reload()">ğŸ”„ ã‚‚ã†ä¸€åº¦æœ€åˆã‹ã‚‰</button>
  </div>

  <script>
    // ========== ã‚²ãƒ¼ãƒ çŠ¶æ…‹ç®¡ç† ==========
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒˆãƒªã‚¬ãƒ¼ä½ç½®ï¼ˆå³ã‹ã‚‰å·¦ã¸ï¼‰
    // 88% ã‚¹ã‚¿ãƒ¼ãƒˆ
    // 72% So much happy
    // 55% ç¥ç¤¾
    // 38% é“å ´
    // 18% ã‚­ã‚¿ãƒ¤ãƒç™»å ´
    
    const gameState = {
      playerX: 88,
      canMove: true,
      // ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ©ã‚°
      kitatayaTalked: false,      // So much happyã¨è©±ã—ãŸ
      shrineTalked: false,        // ç¥ç¤¾ã§è©±ã—ãŸ
      dojoTalked: false,          // é“å ´ã§è©±ã—ãŸ
      kitayamaAppeared: false,    // ã‚­ã‚¿ãƒ¤ãƒç™»å ´æ¸ˆã¿
      kitayamaEventDone: false,   // ã‚­ã‚¿ãƒ¤ãƒã‚¤ãƒ™ãƒ³ãƒˆå®Œäº†
      englishTestDone: false      // è‹±èªãƒ†ã‚¹ãƒˆçµ‚ã‚ã£ãŸè¨­å®š
    };

    // ãƒˆãƒªã‚¬ãƒ¼ä½ç½®
    const TRIGGER = {
      KITATAYA: 72,
      SHRINE: 55,
      DOJO: 38,
      KITAYAMA: 18
    };

    // ========== DOMè¦ç´  ==========
    const player = document.getElementById('player');
    const horse = document.getElementById('horse');
    const eventOverlay = document.getElementById('eventOverlay');
    const eventDialog = document.getElementById('eventDialog');
    const npcKitayama = document.getElementById('npcKitayama');
    const endingOverlay = document.getElementById('endingOverlay');

    let walkTimeout = null;
    let moveInterval = null;

    // ========== ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹• ==========
    function movePlayer(direction) {
      if (!gameState.canMove) return;

      const step = 2;
      const oldX = gameState.playerX;

      if (direction === 'left') {
        const newX = gameState.playerX - step;
        
        // å„ãƒˆãƒªã‚¬ãƒ¼ãƒã‚¤ãƒ³ãƒˆã®ãƒã‚§ãƒƒã‚¯ï¼ˆå·¦ã«é€²ã‚€æ™‚ï¼‰
        // So much happy
        if (!gameState.kitatayaTalked && oldX > TRIGGER.KITATAYA && newX <= TRIGGER.KITATAYA) {
          triggerKitatayaEvent();
          return;
        }
        // ç¥ç¤¾
        if (!gameState.shrineTalked && oldX > TRIGGER.SHRINE && newX <= TRIGGER.SHRINE) {
          triggerShrineEvent();
          return;
        }
        // é“å ´
        if (!gameState.dojoTalked && oldX > TRIGGER.DOJO && newX <= TRIGGER.DOJO) {
          triggerDojoEvent();
          return;
        }
        // ã‚­ã‚¿ãƒ¤ãƒ
        if (!gameState.kitayamaAppeared && oldX > TRIGGER.KITAYAMA && newX <= TRIGGER.KITAYAMA) {
          triggerKitayamaAppearance();
          return;
        }

        if (newX >= 8) {
          gameState.playerX = newX;
          horse.classList.add('flip');
        }
      } else if (direction === 'right') {
        if (gameState.playerX < 92) {
          gameState.playerX += step;
          horse.classList.remove('flip');
        }
      }

      player.style.left = gameState.playerX + '%';
      horse.classList.add('walking');
      clearTimeout(walkTimeout);
      walkTimeout = setTimeout(() => horse.classList.remove('walking'), 200);
    }

    // ========== ã‚¿ãƒƒãƒ—æ“ä½œ ==========
    function startMove(direction) {
      movePlayer(direction);
      moveInterval = setInterval(() => movePlayer(direction), 80);
    }

    function stopMove() {
      clearInterval(moveInterval);
      horse.classList.remove('walking');
    }

    document.getElementById('tapLeft').addEventListener('touchstart', (e) => {
      e.preventDefault();
      startMove('left');
    });
    document.getElementById('tapLeft').addEventListener('touchend', stopMove);
    document.getElementById('tapLeft').addEventListener('touchcancel', stopMove);

    document.getElementById('tapRight').addEventListener('touchstart', (e) => {
      e.preventDefault();
      startMove('right');
    });
    document.getElementById('tapRight').addEventListener('touchend', stopMove);
    document.getElementById('tapRight').addEventListener('touchcancel', stopMove);

    // ãƒã‚¦ã‚¹æ“ä½œï¼ˆPCç”¨ï¼‰
    document.getElementById('tapLeft').addEventListener('mousedown', () => startMove('left'));
    document.getElementById('tapLeft').addEventListener('mouseup', stopMove);
    document.getElementById('tapLeft').addEventListener('mouseleave', stopMove);
    document.getElementById('tapRight').addEventListener('mousedown', () => startMove('right'));
    document.getElementById('tapRight').addEventListener('mouseup', stopMove);
    document.getElementById('tapRight').addEventListener('mouseleave', stopMove);

    // å»ºç‰©ã‚¿ãƒƒãƒ—
    document.getElementById('buildingDojo').addEventListener('click', (e) => {
      e.stopPropagation();
      if (gameState.canMove && !gameState.dojoTalked) triggerDojoEvent();
    });

    document.getElementById('buildingShrine').addEventListener('click', (e) => {
      e.stopPropagation();
      if (gameState.canMove && !gameState.shrineTalked) triggerShrineEvent();
    });

    document.getElementById('npcKitataya').addEventListener('click', (e) => {
      e.stopPropagation();
      if (gameState.canMove && !gameState.kitatayaTalked) triggerKitatayaEvent();
    });

    // ========== So much happy ã‚¤ãƒ™ãƒ³ãƒˆ ==========
    function triggerKitatayaEvent() {
      gameState.canMove = false;
      stopMove();
      showExclamation(document.getElementById('npcKitataya'));

      setTimeout(() => {
        showEventDialog({
          speaker: 'So much happy',
          icon: 'ğŸ˜Š',
          text: 'ã¡ã‚‡ã£ã¨å¾…ã£ã¦ï¼\n\nã‚ã‘ã¾ã—ã¦ãŠã‚ã§ã¨ã†ï¼ï¼\næ–°å¹´ã®ã”æŒ¨æ‹¶ã€èã„ã¦ã„ã‹ãªã„ï¼Ÿ',
          choices: [
            { text: 'èã', action: () => kitatayaGreeting() },
            { text: 'èã‹ãªã„', action: () => kitatayaForceChoice(), canChange: true }
          ]
        });
      }, 500);
    }

    function kitatayaForceChoice() {
      const noBtn = document.querySelector('.choice-btn.no-btn');
      if (noBtn) {
        noBtn.classList.add('changing');
        setTimeout(() => {
          noBtn.textContent = 'èã';
          noBtn.classList.remove('changing');
          noBtn.classList.add('forced');
          noBtn.onclick = () => kitatayaGreeting();
        }, 400);
      }
    }

    function kitatayaGreeting() {
      showEventDialog({
        speaker: 'So much happy',
        icon: 'ğŸ‰',
        text: 'ã‚„ã£ãŸãƒ¼ï¼èã„ã¦ãã‚Œã‚‹ã‚“ã ï¼\n\nğŸ ã‚ã‘ã¾ã—ã¦ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ ğŸ\n\nä»Šå¹´ã‚‚çš†ã•ã‚“ã«ã¨ã£ã¦\nSo much happy ãªä¸€å¹´ã«ãªã‚Šã¾ã™ã‚ˆã†ã«ï¼\n\nå—é¨“ç”Ÿã®çš†ã•ã‚“ã€æœ€å¾Œã¾ã§è«¦ã‚ãšã«\né ‘å¼µã£ã¦ã„ãã¾ã—ã‚‡ã†ï¼ï¼\n\nğŸ“º æ–°å¹´ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‹•ç”»ã‚‚è¦‹ã¦ã„ã£ã¦ã­ï¼',
        choices: [{ text: 'å‹•ç”»ã‚’è¦‹ã‚‹ï¼', action: () => {
          gameState.kitatayaTalked = true;
          gameState.canMove = true;
          closeEventDialog();
          // åŸ‹ã‚è¾¼ã¿å‹•ç”»ã‚’è¡¨ç¤º
          openVideo(VIDEO_IDS.soMuchHappy, 'ğŸ‰ So much happy æ–°å¹´ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸', null);
        }}]
      });
    }

    // ========== ç¥ç¤¾ï¼ˆæ™‚äº‹å•é¡Œï¼‰ã‚¤ãƒ™ãƒ³ãƒˆ ==========
    function triggerShrineEvent() {
      gameState.canMove = false;
      stopMove();
      showExclamation(document.getElementById('buildingShrine'));

      setTimeout(() => {
        showEventDialog({
          speaker: 'ç¥ä¸»',
          icon: 'â›©ï¸',
          text: 'ãŠãŠã€å‚æ‹è€…ã‚ˆã€‚\n\nã“ã“ã¯æ™‚äº‹å•é¡Œç¥ç¤¾ã˜ã‚ƒã€‚\n\n2025å¹´ã®æ™‚äº‹å•é¡Œã‚¯ã‚¤ã‚ºã«\nãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ã¦ã„ã‹ã¬ã‹ï¼Ÿ\n\nâ“ å…¨40å•\nâ±ï¸ ç´„15åˆ†\n\næ™‚äº‹ã‚’çŸ¥ã‚‹è€…ã«ã€åˆæ ¼ã®ç¥æ§˜ã¯å¾®ç¬‘ã‚€ãï¼\n\nğŸš¨ æœ­å¹Œæ—¥å¤§ä¸­å—é¨“è€…ã¯å¿…é ˆã˜ã‚ƒï¼',
          choices: [
            { text: 'ã‚„ã£ã¦ã„ã', action: () => {
              gameState.shrineTalked = true;
              gameState.canMove = true;
              closeEventDialog();
              // å®Ÿéš›ã®ãƒªãƒ³ã‚¯ã«å¤‰æ›´
              openSite('https://yoshimarch.github.io/2026geisyunworldnews/', 'â›©ï¸ æ™‚äº‹å•é¡Œã‚¯ã‚¤ã‚º 2025');
            }},
            { text: 'ã‚„ã‚‰ãªã„', action: () => {
              showEventDialog({
                speaker: 'ç¥ä¸»',
                icon: 'â›©ï¸',
                text: 'ãã†ã‹ã€ã¾ãŸæ°—ãŒå‘ã„ãŸã‚‰æ¥ã‚‹ãŒã‚ˆã„ã€‚\n\nåˆæ ¼ç¥ˆé¡˜ã€ã—ã¦ãŠããï¼ ğŸ™',
                choices: [{ text: 'å…ˆã«é€²ã‚€', action: () => {
                  gameState.shrineTalked = true;
                  gameState.canMove = true;
                  closeEventDialog();
                }}]
              });
            }}
          ]
        });
      }, 500);
    }

    // ========== éå»å•é“å ´ã‚¤ãƒ™ãƒ³ãƒˆ ==========
    function triggerDojoEvent() {
      gameState.canMove = false;
      stopMove();
      showExclamation(document.getElementById('buildingDojo'));

      setTimeout(() => {
        showEventDialog({
          speaker: 'é“å ´é•·',
          icon: 'ğŸ¥‹',
          text: 'ãã“ã®è€…ã€å¾…ãŸã‚Œã‚ˆï¼\n\nã“ã“ã¯éå»å•é“å ´ã˜ã‚ƒã€‚\n\næ­£ç­”ç‡ã®é›†è¨ˆã«å”åŠ›ã—ã¦ãã‚Œã¬ã‹ï¼Ÿ\n\nå›ã®çµæœã‚’å…¥åŠ›ã—ã¦ã‚‚ã‚‰ãˆã‚‹ã¨ã€\nå…¨ä½“ã®å‚¾å‘ãŒè¦‹ãˆã¦çš†ã®å½¹ã«ç«‹ã¤ã®ã˜ã‚ƒã€‚',
          choices: [
            { text: 'å”åŠ›ã™ã‚‹', action: dojoCooperateWarning },
            { text: 'ã‚„ã‚‰ãªã„', action: dojoDecline }
          ]
        });
      }, 500);
    }

    function dojoCooperateWarning() {
      showEventDialog({
        speaker: 'é“å ´é•·',
        icon: 'ğŸ¥‹',
        text: 'ãŠãŠã€ã‚ã‚ŠãŒãŸã„ï¼\n\nâš ï¸ ãŸã ã—ã€ä¸€ã¤å¤§äº‹ãªã“ã¨ã‚’ä¼ãˆã¦ãŠãã€‚\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nã€å¿…ãšãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã§å…¥åŠ›ã™ã‚‹ã“ã¨ã€‘\nå®Ÿåã¯çµ¶å¯¾ã«å…¥ã‚Œã¦ã¯ãªã‚‰ã¬ãï¼\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã‚’å®ˆã‚‹ã“ã¨ãŒå¤§åˆ‡ã˜ã‚ƒã€‚',
        choices: [
          { text: 'ã‚ã‹ã£ãŸï¼å…¥åŠ›ã™ã‚‹', action: () => {
            gameState.dojoTalked = true;
            gameState.englishTestDone = true;
            gameState.canMove = true;
            closeEventDialog();
            // å®Ÿéš›ã®ãƒªãƒ³ã‚¯ã«å¤‰æ›´
            openSite('https://text-order-project.web.app/', 'ğŸ¥‹ éå»å•çµæœå…¥åŠ›');
          }},
          { text: 'ã‚„ã£ã±ã‚Šã‚„ã‚ã‚‹', action: dojoDecline }
        ]
      });
    }

    function dojoDecline() {
      showEventDialog({
        speaker: 'é“å ´é•·',
        icon: 'ğŸ¥‹',
        text: 'ãã†ã‹ã€ã¾ãŸæ°—ãŒå‘ã„ãŸã‚‰æ¥ã‚‹ãŒã‚ˆã„ã€‚\n\néå»å•æ¼”ç¿’ã€é ‘å¼µã‚‹ã®ã˜ã‚ƒãï¼ ğŸ’ª',
        choices: [{ text: 'å…ˆã«é€²ã‚€', action: () => {
          gameState.dojoTalked = true;
          gameState.canMove = true;
          closeEventDialog();
        }}]
      });
    }

    // ========== ã‚­ã‚¿ãƒ¤ãƒã‚¤ãƒ™ãƒ³ãƒˆ ==========
    function triggerKitayamaAppearance() {
      gameState.kitayamaAppeared = true;
      gameState.canMove = false;
      stopMove();

      setTimeout(() => {
        npcKitayama.classList.add('appear');
        
        setTimeout(() => {
          showExclamation(npcKitayama);
        }, 700);

        setTimeout(() => {
          showEventDialog({
            speaker: 'ã‚­ã‚¿ãƒ¤ãƒ',
            icon: 'âœ¨',
            text: 'Oh...?\n\nãã“ã®å›ã€ã¡ã‚‡ã£ã¨å¾…ã¡ãŸã¾ãˆã€‚\n\nç§ã®åã¯ã‚­ã‚¿ãƒ¤ãƒ...\nã“ã®ç”ºä¸€ç•ªã®è‹±èªè¬›å¸«ã•ã€‚\n\nãµãµã€å›ã®ãã®ç›®...\nè‹±èªã®å®ŸåŠ›ã‚’é«˜ã‚ãŸã„ã¨è¨€ã£ã¦ã„ã‚‹ã­ï¼Ÿ',
            choices: [{ text: '...ãˆã£', action: kitayamaAskTest }]
          });
        }, 1400);
      }, 300);
    }

    function kitayamaAskTest() {
      showEventDialog({
        speaker: 'ã‚­ã‚¿ãƒ¤ãƒ',
        icon: 'ğŸ¤”',
        text: 'ãã®å‰ã«ä¸€ã¤èã‹ã›ã¦ã‚‚ã‚‰ãŠã†ã€‚\n\nè‹±èªã®ãƒ†ã‚¹ãƒˆã¾ã§...\néå»å•ã¯çµ‚ã‚ã£ã¦ã„ã‚‹ã‹ã„ï¼Ÿ',
        choices: [
          { text: 'ã¯ã„ã€çµ‚ã‚ã‚Šã¾ã—ãŸ', action: kitayamaProposal },
          { text: 'ã„ã„ãˆã€ã¾ã ã§ã™', action: kitayamaReject },
          { text: 'ã„ã‚„ã€ç§ã¯å°6ã§ã™', action: kitayamaForElementary }
        ]
      });
    }

    function kitayamaReject() {
      showEventDialog({
        speaker: 'ã‚­ã‚¿ãƒ¤ãƒ',
        icon: 'ğŸ˜',
        text: 'ãµãµ...\n\nã¾ã çµ‚ã‚ã£ã¦ã„ãªã„ã®ã‹ã„ï¼Ÿ\n\nãã‚Œã§ã¯ã“ã“ã‚’é€šã™ã‚ã‘ã«ã¯ã„ã‹ãªã„ãªã€‚\n\nã¾ãšã¯éå»å•ã‚’çµ‚ã‚ã‚‰ã›ã¦ãã‚‹ã‚“ã ã€‚\nè©±ã¯ãã‚Œã‹ã‚‰ã•ã€‚\n\nâœ¨ Stay focused âœ¨',
        choices: [{ text: 'ã‚ã‹ã‚Šã¾ã—ãŸ...', action: () => {
          gameState.kitayamaAppeared = false;
          npcKitayama.classList.remove('appear');
          gameState.canMove = true;
          closeEventDialog();
        }}]
      });
    }

    // ========== å°6å‘ã‘ç‰¹åˆ¥ãƒ«ãƒ¼ãƒˆ ==========
    function kitayamaForElementary() {
      showEventDialog({
        speaker: 'ã‚­ã‚¿ãƒ¤ãƒ',
        icon: 'âœ¨',
        text: 'ãŠãŠ...å°6ã‹ã„ï¼Ÿ\n\nã¤ã¾ã‚Šä¸­å­¦å—é¨“ç”Ÿã¨ã„ã†ã‚ã‘ã ã€‚\n\nãµãµã€ãã‚Œãªã‚‰è©±ã¯åˆ¥ã ã€‚\n\nå›ã®ã‚ˆã†ãªè‹¥ãæŒ‘æˆ¦è€…ã«\nç§ã‹ã‚‰ç‰¹åˆ¥ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è´ˆã‚ã†ã€‚',
        choices: [{ text: 'èã‹ã›ã¦ãã ã•ã„', action: kitayamaElementaryMessage }]
      });
    }

    function kitayamaElementaryMessage() {
      showEventDialog({
        speaker: 'ã‚­ã‚¿ãƒ¤ãƒ',
        icon: 'ğŸŒŸ',
        text: 'ä¸­å­¦å—é¨“ã¯äººç”Ÿã§æœ€åˆã®å¤§ããªæŒ‘æˆ¦ã ã€‚\n\nä¸å®‰ã‚‚ã‚ã‚‹ã ã‚ã†ã€‚\nã§ã‚‚ã€ã“ã“ã¾ã§é ‘å¼µã£ã¦ããŸå›ãªã‚‰å¤§ä¸ˆå¤«ã€‚\n\nè‡ªåˆ†ã‚’ä¿¡ã˜ã¦ã€æœ€å¾Œã¾ã§è«¦ã‚ã‚‹ãªã€‚\n\n...ã‚‚ã†å°‘ã—èã„ã¦ã„ãã‹ã„ï¼Ÿ',
        choices: [
          { text: 'ã¾ã èã', action: kitayamaElementaryGoodEnding },
          { text: 'èãã®ã‚’ã‚„ã‚ã‚‹', action: kitayamaElementaryForceChoice, canChange: true }
        ]
      });
    }

    function kitayamaElementaryForceChoice() {
      const noBtn = document.querySelector('.choice-btn.no-btn');
      if (noBtn) {
        noBtn.classList.add('changing');
        setTimeout(() => {
          noBtn.textContent = 'ã‚‚ã£ã¨èããŸã„';
          noBtn.classList.remove('changing');
          noBtn.classList.add('forced');
          noBtn.onclick = kitayamaElementaryLongMessage;
        }, 400);
      }
    }

    function kitayamaElementaryGoodEnding() {
      showEventDialog({
        speaker: 'ã‚­ã‚¿ãƒ¤ãƒ',
        icon: 'ğŸ’«',
        text: 'ã‚ˆã—...\n\nãã®å§¿å‹¢ãŒã‚ã‚Œã°å¤§ä¸ˆå¤«ã ã€‚\n\nå›ã®åˆæ ¼ã‚’å¿ƒã‹ã‚‰ç¥ˆã£ã¦ã„ã‚‹ã‚ˆã€‚\n\nâœ¨ Stay brilliant âœ¨\n\n...ã•ã‚ã€è¡ŒããŸã¾ãˆã€‚\næ˜¥ã¯ã‚‚ã†ã™ããã“ã ã€‚',
        choices: [{ text: 'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼', action: () => {
          gameState.kitayamaEventDone = true;
          closeEventDialog();
          setTimeout(() => showEnding(), 800);
        }}]
      });
    }

    function kitayamaElementaryLongMessage() {
      showEventDialog({
        speaker: 'ã‚­ã‚¿ãƒ¤ãƒ',
        icon: 'âœ¨',
        text: 'ãµãµã€ãã†ã‹ãã†ã‹...\nèããŸã„ã‹ã€‚ã‚ˆã‚ã—ã„ã€‚\n\nå—é¨“ã¨ã„ã†ã®ã¯ã­ã€çµæœã ã‘ãŒã™ã¹ã¦ã˜ã‚ƒãªã„ã€‚ã“ã®çµŒé¨“ã§å¾—ãŸã€ŒåŠªåŠ›ã™ã‚‹åŠ›ã€ã€Œè«¦ã‚ãªã„å¿ƒã€ã€Œè¨ˆç”»ã‚’ç«‹ã¦ã¦å®Ÿè¡Œã™ã‚‹åŠ›ã€...ã“ã‚Œã‚‰ã¯ä¸€ç”Ÿã®è²¡ç”£ã«ãªã‚‹ã€‚',
        choices: [{ text: '...', action: kitayamaElementaryLongMessage2 }]
      });
    }

    function kitayamaElementaryLongMessage2() {
      showEventDialog({
        speaker: 'ã‚­ã‚¿ãƒ¤ãƒ',
        icon: 'ğŸ’«',
        text: 'è©¦é¨“å½“æ—¥ã¯ç·Šå¼µã™ã‚‹ã ã‚ã†ã€‚ã§ã‚‚ã€ãã‚Œã¯å›ã ã‘ã˜ã‚ƒãªã„ã€‚å…¨å“¡ãŒåŒã˜æ°—æŒã¡ã ã€‚æ·±å‘¼å¸ã—ã¦ã€ã„ã¤ã‚‚é€šã‚Šã®è‡ªåˆ†ã‚’å‡ºã›ã°ã„ã„ã€‚åˆ†ã‹ã‚‰ãªã„å•é¡ŒãŒã‚ã£ã¦ã‚‚ç„¦ã‚‹ãªã€‚ã§ãã‚‹å•é¡Œã‚’ç¢ºå®Ÿã«ã€‚',
        choices: [{ text: '...ãªã‚‹ã»ã©', action: kitayamaElementaryLongMessage3 }]
      });
    }

    function kitayamaElementaryLongMessage3() {
      showEventDialog({
        speaker: 'ã‚­ã‚¿ãƒ¤ãƒ',
        icon: 'ğŸ˜…',
        text: 'ãã—ã¦ä½•ã‚ˆã‚Šå¤§åˆ‡ãªã®ã¯...\n\nä½“èª¿ç®¡ç†ã ã€‚ç¡çœ ã‚’ã—ã£ã‹ã‚Šå–ã£ã¦...\n\næ‰‹æ´—ã„ã†ãŒã„ã‚’å¿˜ã‚Œãšã«...\n\n......ãµã…ã€‚\n\n...ã•ã™ãŒã«å–‹ã‚Šã™ããŸã€‚\n\nç§ã¨ã—ãŸã“ã¨ãŒ...å°‘ã—ç–²ã‚ŒãŸã‚ˆ...',
        choices: [{ text: 'ãŠç–²ã‚Œã•ã¾ã§ã™...', action: kitayamaElementaryTiredEnding }]
      });
    }

    function kitayamaElementaryTiredEnding() {
      showEventDialog({
        speaker: 'ã‚­ã‚¿ãƒ¤ãƒ',
        icon: 'ğŸ˜Œ',
        text: 'ã¾ã‚...å›ã®ãŸã‚ã ã‹ã‚‰ã­...\n\nç§ã®è¨€è‘‰ã€å°‘ã—ã§ã‚‚å±Šã„ã¦ã„ã‚Œã°å¬‰ã—ã„ã€‚\n\n...ã•ã‚ã€ã‚‚ã†è¡Œããªã•ã„ã€‚\n\nåˆæ ¼ã‚’ç¥ˆã£ã¦ã„ã‚‹ã‚ˆã€‚\n\nâœ¨ ...Stay...gorgeous... âœ¨',
        choices: [{ text: 'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼', action: () => {
          gameState.kitayamaEventDone = true;
          closeEventDialog();
          setTimeout(() => showEnding(), 800);
        }}]
      });
    }

    function kitayamaProposal() {
      showEventDialog({
        speaker: 'ã‚­ã‚¿ãƒ¤ãƒ',
        icon: 'ğŸ’«',
        text: 'ãŠãŠã€ç´ æ™´ã‚‰ã—ã„ï¼\n\nå›ã€ãªã‹ãªã‹ã‚„ã‚‹ã˜ã‚ƒãªã„ã‹ã€‚\n\nç§ã®YouTubeãƒãƒ£ãƒ³ãƒãƒ«ã§\nç‰¹åˆ¥ãªè‹±èªè§£èª¬å‹•ç”»ã‚’å…¬é–‹ã—ã¦ã„ã‚‹ã‚“ã ã€‚\n\nèã„ã¦ã„ãã‹ã„ï¼Ÿ\n\nãã£ã¨å›ã®è‹±èªåŠ›ãŒ...\nâœ¨ è¼ãå‡ºã™ âœ¨ ã¯ãšã•ã€‚',
        choices: [
          { text: 'èã', action: goToYoutube },
          { text: 'èã‹ãªã„', action: kitayamaForceChoice, canChange: true }
        ]
      });
    }

    function kitayamaForceChoice() {
      const noBtn = document.querySelector('.choice-btn.no-btn');
      if (noBtn) {
        noBtn.classList.add('changing');
        
        setTimeout(() => {
          showEventDialog({
            speaker: 'ã‚­ã‚¿ãƒ¤ãƒ',
            icon: 'ğŸ˜',
            text: 'ãµãµ...\n\nã€Œèã‹ãªã„ã€ã ã£ã¦ï¼Ÿ\n\n...\n\nãã‚“ãªé¸æŠè‚¢...\næœ€åˆã‹ã‚‰ãªã‹ã£ãŸã®ã•ã€‚',
            choices: [
              { text: 'èã', action: goToYoutube },
              { text: 'èã', action: goToYoutube }
            ]
          });
        }, 400);
      }
    }

    function goToYoutube() {
      showEventDialog({
        speaker: 'ã‚­ã‚¿ãƒ¤ãƒ',
        icon: 'ğŸŒŸ',
        text: 'ã„ã„é¸æŠã ...\n\nç§ã®ç¾ã—ã„è§£èª¬ã‚’å ªèƒ½ã—ãŸã¾ãˆã€‚\n\nã§ã¯ã¾ãŸä¼šãŠã†...\n\nâœ¨ Stay gorgeous âœ¨',
        choices: [{ text: 'å‹•ç”»ã‚’è¦‹ã‚‹', action: () => {
          gameState.kitayamaEventDone = true;
          closeEventDialog();
          // å¤§ãã„åŸ‹ã‚è¾¼ã¿å‹•ç”»ã‚’è¡¨ç¤ºã€é–‰ã˜ãŸå¾Œã«ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã¸
          openVideo(VIDEO_IDS.kitayama, 'âœ¨ ã‚­ã‚¿ãƒ¤ãƒã®è‹±èªè§£èª¬ âœ¨', () => {
            setTimeout(() => showEnding(), 500);
          }, true);  // true = å¤§ãã„ãƒ¢ãƒ¼ãƒ€ãƒ«
        }}]
      });
    }

    // ========== ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚° ==========
    function showEnding() {
      // BGMã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
      if (bgmEnabled && !bgm.paused) {
        let fadeOut = setInterval(() => {
          if (bgm.volume > 0.1) {
            bgm.volume -= 0.1;
          } else {
            bgm.pause();
            clearInterval(fadeOut);
          }
        }, 200);
      }
      endingOverlay.classList.add('active');
    }

    // ========== ã‚¤ãƒ™ãƒ³ãƒˆãƒ€ã‚¤ã‚¢ãƒ­ã‚° ==========
    function showEventDialog(config) {
      gameState.canMove = false;
      stopMove();
      eventOverlay.classList.add('active');
      eventDialog.classList.add('active');
      
      document.getElementById('speakerIcon').textContent = config.icon;
      document.getElementById('speakerName').textContent = config.speaker;
      
      const textEl = document.getElementById('eventText');
      textEl.textContent = '';
      typeWriter(textEl, config.text, 0);

      const choicesEl = document.getElementById('eventChoices');
      choicesEl.innerHTML = '';
      
      config.choices.forEach((choice) => {
        const btn = document.createElement('button');
        btn.className = 'choice-btn' + (choice.canChange ? ' no-btn' : '');
        btn.textContent = choice.text;
        btn.onclick = choice.action;
        choicesEl.appendChild(btn);
      });
    }

    function typeWriter(element, text, index) {
      if (index < text.length) {
        element.textContent += text.charAt(index);
        setTimeout(() => typeWriter(element, text, index + 1), 25);
      }
    }

    function closeEventDialog() {
      eventOverlay.classList.remove('active');
      eventDialog.classList.remove('active');
    }

    // ========== æ„Ÿå˜†ç¬¦ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ ==========
    function showExclamation(element) {
      const rect = element.getBoundingClientRect();
      const excl = document.createElement('div');
      excl.className = 'exclamation';
      excl.textContent = 'â—';
      excl.style.left = (rect.left + rect.width / 2 - 17) + 'px';
      excl.style.top = (rect.top - 45) + 'px';
      document.body.appendChild(excl);
      
      setTimeout(() => excl.remove(), 1500);
    }

    // ========== é›ªãƒ»æ˜Ÿã®ç”Ÿæˆ ==========
    function createSnowflakes() {
      const container = document.getElementById('snowflakes');
      const flakeChars = ['â„', 'â…', 'â†', 'â€¢'];
      
      for (let i = 0; i < 40; i++) {
        const flake = document.createElement('div');
        flake.className = 'snowflake';
        flake.textContent = flakeChars[Math.floor(Math.random() * flakeChars.length)];
        flake.style.left = Math.random() * 100 + '%';
        flake.style.fontSize = (Math.random() * 0.7 + 0.4) + 'em';
        flake.style.animationDuration = (Math.random() * 5 + 6) + 's';
        flake.style.animationDelay = (Math.random() * 10) + 's';
        container.appendChild(flake);
      }
    }

    function createStars() {
      const container = document.getElementById('stars');
      
      for (let i = 0; i < 60; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 100 + '%';
        star.style.animationDelay = (Math.random() * 2) + 's';
        container.appendChild(star);
      }
    }

    // ========== ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œï¼ˆPCç”¨ï¼‰ ==========
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') movePlayer('left');
      else if (e.key === 'ArrowRight') movePlayer('right');
    });

    // ========== BGMåˆ¶å¾¡ ==========
    const bgm = document.getElementById('bgm');
    const bgmBtn = document.getElementById('bgmBtn');
    const bgmPrompt = document.getElementById('bgmPrompt');
    let bgmEnabled = false;

    // ========== YouTubeå‹•ç”»è¨­å®š ==========
    const VIDEO_IDS = {
      soMuchHappy: 'Rl6WnNdDf4g',  // So much happyã®æŒ¨æ‹¶å‹•ç”»
      kitayama: 'XpB7llDefjg'       // ã‚­ã‚¿ãƒ¤ãƒã®è‹±èªè§£èª¬
    };

    // ========== å®‰å…¨ã«åˆ¥ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§é–‹ãé–¢æ•° ==========
    function openInNewTab(url) {
      // æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã¨ã—ã¦é–‹ãï¼ˆã‚¿ãƒ–ã§ã¯ãªãã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ï¼‰
      const newWindow = window.open(url, '_blank', 'width=1024,height=768,menubar=yes,toolbar=yes,location=yes,status=yes,scrollbars=yes,resizable=yes');
      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«
      if (newWindow) {
        newWindow.focus();
      }
    }

    // ========== å¤–éƒ¨ã‚µã‚¤ãƒˆåŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡ ==========
    const siteModal = document.getElementById('siteModal');
    const siteIframe = document.getElementById('siteIframe');
    const siteModalTitle = document.getElementById('siteModalTitle');

    function openSite(url, title) {
      // BGMã‚’ä¸€æ™‚åœæ­¢
      if (bgmEnabled && !bgm.paused) {
        bgm.pause();
      }
      
      siteModalTitle.textContent = title || 'ğŸ“ å¤–éƒ¨ã‚µã‚¤ãƒˆ';
      siteIframe.src = url;
      siteModal.classList.add('active');
    }

    function closeSite() {
      siteIframe.src = '';
      siteModal.classList.remove('active');
      
      // BGMã‚’å†é–‹
      if (bgmEnabled) {
        bgm.play().catch(e => console.log('BGMå†ç”Ÿã‚¨ãƒ©ãƒ¼:', e));
      }
    }

    // ========== å‹•ç”»ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡ ==========
    const videoModal = document.getElementById('videoModal');
    const videoIframe = document.getElementById('videoIframe');
    const videoModalTitle = document.getElementById('videoModalTitle');
    let videoCallback = null;

    function openVideo(videoId, title, callback, isLarge = false) {
      // BGMã‚’ä¸€æ™‚åœæ­¢
      if (bgmEnabled && !bgm.paused) {
        bgm.pause();
      }
      
      videoModalTitle.textContent = title || 'ğŸ“º å‹•ç”»ã‚’è¦‹ã‚‹';
      videoIframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
      
      // å¤§ãã„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã©ã†ã‹
      if (isLarge) {
        videoModal.classList.add('large');
      } else {
        videoModal.classList.remove('large');
      }
      
      videoModal.classList.add('active');
      videoCallback = callback;
    }

    function closeVideo() {
      videoIframe.src = '';
      videoModal.classList.remove('active');
      videoModal.classList.remove('large');
      
      // BGMã‚’å†é–‹
      if (bgmEnabled) {
        bgm.play().catch(e => console.log('BGMå†ç”Ÿã‚¨ãƒ©ãƒ¼:', e));
      }
      
      // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
      if (videoCallback) {
        videoCallback();
        videoCallback = null;
      }
    }

    function startWithBGM() {
      bgmEnabled = true;
      bgm.volume = 0.5; // éŸ³é‡50%
      bgm.play().catch(e => console.log('BGMå†ç”Ÿã‚¨ãƒ©ãƒ¼:', e));
      bgmBtn.textContent = 'ğŸ”Š BGM';
      bgmBtn.classList.add('playing');
      bgmPrompt.classList.add('hidden');
    }

    function startWithoutBGM() {
      bgmEnabled = false;
      bgmPrompt.classList.add('hidden');
    }

    function toggleBGM() {
      if (bgm.paused) {
        bgm.play().catch(e => console.log('BGMå†ç”Ÿã‚¨ãƒ©ãƒ¼:', e));
        bgmBtn.textContent = 'ğŸ”Š BGM';
        bgmBtn.classList.add('playing');
        bgmEnabled = true;
      } else {
        bgm.pause();
        bgmBtn.textContent = 'ğŸ”‡ BGM';
        bgmBtn.classList.remove('playing');
        bgmEnabled = false;
      }
    }

    // ========== åˆæœŸåŒ– ==========
    function init() {
      createSnowflakes();
      createStars();
      player.style.left = gameState.playerX + '%';
      horse.classList.add('flip');
      
      // é•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰ã‚’ç„¡åŠ¹åŒ–
      document.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }, { passive: false });
      
      // é•·æŠ¼ã—ã«ã‚ˆã‚‹é¸æŠã‚’ç„¡åŠ¹åŒ–
      document.addEventListener('selectstart', (e) => {
        e.preventDefault();
        return false;
      }, { passive: false });
      
      // é•·æŠ¼ã—ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆChromeã®é•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼å¯¾ç­–ï¼‰
      let longPressTimer = null;
      
      document.addEventListener('touchstart', (e) => {
        // é•·æŠ¼ã—ã«ã‚ˆã‚‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºã‚’é˜²ã
        if (longPressTimer) clearTimeout(longPressTimer);
        longPressTimer = setTimeout(() => {
          // ä½•ã‚‚ã—ãªã„ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œã‚’ãƒ–ãƒ­ãƒƒã‚¯ï¼‰
        }, 500);
      }, { passive: true });
      
      document.addEventListener('touchend', () => {
        if (longPressTimer) {
          clearTimeout(longPressTimer);
          longPressTimer = null;
        }
      }, { passive: true });
      
      document.addEventListener('touchmove', () => {
        if (longPressTimer) {
          clearTimeout(longPressTimer);
          longPressTimer = null;
        }
      }, { passive: true });
      
      // ç”»åƒã®é•·æŠ¼ã—ãƒ‰ãƒ©ãƒƒã‚°ã‚’ç„¡åŠ¹åŒ–
      document.addEventListener('dragstart', (e) => {
        e.preventDefault();
        return false;
      });
    }

    init();
  </script>
</body>
</html>
